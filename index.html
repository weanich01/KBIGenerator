<!-- Include stylesheet -->
<html>
<head>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/icons-react/dist/index.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    <style type="text/css">


        .ql-snow {
            .ql-picker

        {
            &.ql-size

        {
            .ql-picker-label, .ql-picker-item

        {
            &::before

        {
            content: '' !important;
        }

        }
        }
        }
        }

        .ql-container {
            height: 200px;
        }

        .ql-editor {
            font-family: Arial !important;
            white-space: pre-wrap !important;
        }

        p:empty:not(:focus)::before {
            content: attr(data-placeholder);
        }


        img {
            max-width: 352px !important;
            max-height: 210px !important;
        }

        .ql-contextmenu {
            border: 2px solid #cacaca;
            background: #ffffff;
            width: auto;
        }

        .ql-contextmenu-btn {
            background-color: white !important;
            z-index: 10000;
            width: 98%;
            text-align: left;
            display: block;
            font-size: 14px;
            border: none;
            padding: 3px;
            margin: 3px;
        }

        button.ql-contextmenu-btn:hover {
            background-color: #E8E8E9 !important;
        }

        .section-header {
            margin-top: 30px;
        }

        i {
            margin-right: 5px;
        }

        .ql-container {
            height: auto;
            min-height: 200px;
        }

        .ql-editor {
            height: auto;
            font-family: Arial !important;
        }

        #text .correct {
            border-bottom: 2px solid green;
        }

        #text .misspelled {
            border-bottom: 2px solid red;
        }

        u {
            text-decoration-line: none;
        }

        body, button, span, svg, div, img, h1, h2, h3, h4, h5, h6, p, u {
            font-family: Arial !important;
        }

        body {
            overflow-y: scroll;
        }

        p {
            font-size: 14px;
        }

            p:blank:before {
                content: 'abc';
            }

        div.ql-toolbar.ql-snow {
            border: none !important;
            display: inline-block;
        }

        .section-header {
            display: inline-block;
        }

        .ql-container.ql-snow {
            border: none !important;
        }

        #editor, #editor2 {
            min-height: 60px !important;
            height: auto;
        }

        .ql-picker.ql-size .ql-picker-item[data-value="10px"]::before {
            content: '10' !important;
        }

        .ql-picker.ql-size .ql-picker-item[data-value="12px"]::before {
            content: '12' !important;
        }

        .ql-picker.ql-size .ql-picker-item[data-value="14px"]::before {
            content: '14' !important;
        }

        .ql-picker.ql-size .ql-picker-item[data-value="16px"]::before {
            content: '16' !important;
        }

        /* set font-size picker */
        .ql-size {
            width: 30px !important;
            font-size: 12.5px !important;
        }

            .ql-size > .ql-picker-label {
                width: 40px !important;
                padding: 3px 5px !important;
                border: 1px solid black !important;
            }

            .ql-size > .ql-picker-options {
                width: 40px !important;
                border: 1px solid black !important;
                padding: 0px !important;
            }

                .ql-size > .ql-picker-options > .ql-picker-item {
                    width: 100% !important;
                    display: block !important;
                    text-align: center
                }

                    .ql-size > .ql-picker-options > .ql-picker-item:hover {
                        width: 100% !important;
                        display: block !important;
                        text-align: center;
                        background-color: rgb(29,139,245);
                        color: white;
                    }

        .ql-snow .ql-picker:not(.ql-color-picker):not(.ql-icon-picker) svg {
            /*right:3px!important*/
        }

        .ql-formats {
            margin-right: 0px !important;
        }

        .ql-color {
            margin-left: 14px;
        }

        #editor > .ql-editor, #editor2 > .ql-editor {
            white-space: nowrap !important;
            overflow: hidden;
        }
    </style>

    <script>
        var ignoreTextLocal = [];
        if (localStorage.getItem('ignoreTextLocal') == null) {
            localStorage.setItem('ignoreTextLocal', JSON.stringify(ignoreTextLocal));
        } else {
            ignoreTextLocal = JSON.parse(localStorage.getItem('ignoreTextLocal'));
        }
        var typo = null;
        var isRun = false;
        document.addEventListener("DOMContentLoaded", function () {
            const inputText = document.getElementById("input-text");
            const outputText = document.getElementById("output-text");

            typo = new Typo("en_US"); // Create a Typo instance for the English language.


        });
    </script>

</head>

<body>
    <h1 style="text-align:center">KBI Generator</h1>
    <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Version</strong></p>
    <div id="editor"></div>
    <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Date</strong></p>
    <div id="editor2"></div>
    <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Summary</strong></p>
    <div id="editor3"></div>
    <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Technical Background</strong></p>
    <div id="editor4"></div>
    <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Resolution</strong></p>
    <div id="editor5"></div>

    <div id="ql-contextmenu" class="ql-contextmenu">
        <button class="ql-contextmenu-btn" id="ignoreText">
            <i class="ti ti-vocabulary"></i><span id="ignoreTextSpan"></span>
        </button>
        <button class="ql-contextmenu-btn" id="addToDict">
            <i class="ti ti-vocabulary"></i><span id="addToDictSpan"></span>
        </button>
        <button class="ql-contextmenu-btn" id="deleteImage">
            <i class="ti ti-photo"></i><span>Delete Image</span>
        </button>
        <button class="ql-contextmenu-btn" id="insertImage" onclick="insertImage()">
            <i class="ti ti-photo"></i>Insert Image Here
        </button>
        <button id="showMockup" class="ql-contextmenu-btn"><i class="ti ti-presentation"></i>Show Mockup</button>
        <button id="generateKbi" class="ql-contextmenu-btn"><i class="ti ti-file-export"></i>Generate KBI</button>
    </div>
    <div id="root"></div>
</body>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<!-- Include the Quill library -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://cdn.jsdelivr.net/gh/cfinke/Typo.js/typo/typo.js"></script>

<!-- Initialize Quill editor -->
<script>
    var Size = Quill.import('attributors/style/size');
    Size.whitelist = [
        "10px",
        "12px",
        "14px",
        "16px"
    ];

    Quill.register(Size, true);
    let Inline = Quill.import('blots/inline');

    var icons = Quill.import('ui/icons');
    icons['bold'] = '<strong>B</strong>';
    console.log(icons['color']);
    icons['color'] = `
<div style="display: block;position: relative;top: 0;left: 0;">A</div>
<svg viewBox="0 0 18 18" style="position:relative;top:-15px;">
<line class="ql-color-label ql-stroke ql-transparent" x1="3" x2="15" y1="15" y2="15" style=""></line>  <line class="" x1="11.63" x2="6.38" y1="9" y2="9"></line> </svg>`

    class ctBlot extends Inline { }
    ctBlot.blotName = 'ct';
    ctBlot.tagName = 'ct';

    Quill.register(ctBlot);
    var toolbarOptions = [
        ['image'],
        ['underline'],
        // ['preview'],
        //  ['generate'],
        ['bold'],        // toggled buttons

        [{
            'size': ["10px",
                "12px",
                "14px",
                "16px"]
        }],  // custom dropdown
        [{ 'color': [] }],

    ];

    var textToolbarOptions = [
        ['underline'],
        // ['preview'],
        //  ['generate'],
        ['bold'],        // toggled buttons

        [{
            'size': ["10px",
                "12px",
                "14px",
                "16px"]
        }],  // custom dropdown
        [{ 'color': [] }],

    ];

    var textFormats = [
        'background',
        'bold',
        'color',
        'italic',
        'size',
        'underline',
        'indent',
        'list',
        'align',
        'direction',
        // 'image'
        // 'video'
    ];

    var articleFormats = [
        'background',
        'bold',
        'color',
        'italic',
        'size',
        'underline',
        'indent',
        'list',
        'align',
        'direction',
        'image'
        // 'video'
    ];

    var formatWhitelist = ['bold', 'underline'];
    var quill = new Quill('#editor', {
        modules: {
            toolbar: textToolbarOptions
        },
        placeholder: 'Your Text Here',
        theme: 'snow',
        formats: textFormats
    });

    

   
    quill.getModule('keyboard').bindings[13] = null;
    var quill2 = new Quill('#editor2', {
        modules: {
            toolbar: textToolbarOptions
        },
        placeholder: 'Your Text Here',
        theme: 'snow',
        formats: textFormats
    });

     const currentDate = new Date();
    const formattedDate = formatDate(currentDate);
    quill2.setText(formattedDate);
    quill2.getModule('keyboard').bindings[13] = null;
    var quill3 = new Quill('#editor3', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your Text Here',
        theme: 'snow',
        formats: articleFormats
    });


    var quill4 = new Quill('#editor4', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your Text Here',
        theme: 'snow',
        formats: articleFormats
    });
    var quill5 = new Quill('#editor5', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your Text Here',
        theme: 'snow',
        formats: articleFormats
    });
    // need to handle incase character more than 1 line
    var quill1LastText = "";
    quill.on("text-change", (delta, oldDelta, source) => {
        var text = quill.getText();
        if (hasOneCharDifference(quill1LastText, quill.getText())) {
            if (!isWhitespace(getLatestCharacterWithoutNewline(quill.getText()))) {
                if (quill.getText(quill.getSelection().index, 1) == '\n')
                    quill1LastText = quill.getText();
                return;
            }
        }
        quill1LastText = quill.getText();
        if (text.length > 100) {
            let restrictValue = '';
            for (let i = 0; i < oldDelta.ops.length; i++) {
                if (oldDelta.ops[i].insert != null) {
                    restrictValue += oldDelta.ops[i].insert;
                }
            }

            quill.setText(restrictValue.substring(0, 99))
        }
        checkAndreturn($('#editor > .ql-editor')[0])
    });

    var quill2LastText = "";
    quill2.on("text-change", (delta, oldDelta, source) => {
        var text = quill2.getText();
        if (hasOneCharDifference(quill2LastText, quill2.getText())) {
            if (!isWhitespace(getLatestCharacterWithoutNewline(quill2.getText()))) {
                if (quill2.getText(quill2.getSelection().index, 1) == '\n')
                    quill2LastText = quill2.getText();
                return;
            }
        }
        quill2LastText = quill2.getText();
        if (text.length > 100) {
            let restrictValue = '';
            for (let i = 0; i < oldDelta.ops.length; i++) {
                if (oldDelta.ops[i].insert != null) {
                    restrictValue += oldDelta.ops[i].insert;
                }
            }

            quill2.setText(restrictValue.substring(0, 99))
        }
        checkAndreturn($('#editor2 > .ql-editor')[0])
    });


    var quill3LastText = "";
    quill3.on("text-change", (delta, oldDelta, source) => {
        var text = quill3.getText();
        if (hasOneCharDifference(quill3LastText, quill3.getText())) {
            if (!isWhitespace(getLatestCharacterWithoutNewline(quill3.getText()))) {
                if (quill3.getText(quill3.getSelection().index, 1) == '\n'
                    && quill3.getText(quill3.getSelection().index + 1, 1) != '\n') {
                    quill3LastText = quill3.getText();
                    return;
                }
            }
        }
        quill3LastText = quill3.getText();
        if (source === 'user') {
            delta.ops.forEach(function (op) {
                if (op.insert && op.insert.image) {
                    console.log('insert image');
                    setTimeout(function () {
                        checkAndreturn($('#editor3 > .ql-editor')[0])
                        checkAndreturn($('#editor4 > .ql-editor')[0])
                        checkAndreturn($('#editor5 > .ql-editor')[0])
                    }, 500);
                    return;
                }
            });

            checkAndreturn($('#editor3 > .ql-editor')[0])
            checkAndreturn($('#editor4 > .ql-editor')[0])
            checkAndreturn($('#editor5 > .ql-editor')[0])
        }

    });

    var quill4LastText = ""
    quill4.on("text-change", (delta, oldDelta, source) => {
        var text = quill4.getText();
        if (hasOneCharDifference(quill4LastText, quill4.getText())) {
            if (!isWhitespace(getLatestCharacterWithoutNewline(quill4.getText()))) {
                if (quill4.getText(quill4.getSelection().index, 1) == '\n'
                    && quill4.getText(quill4.getSelection().index + 1, 1) != '\n') {
                    quill4LastText = quill4.getText();
                    return;
                }
            }
        }
        quill4LastText = quill4.getText();
        if (source === 'user') {
            delta.ops.forEach(function (op) {
                if (op.insert && op.insert.image) {
                    console.log('insert image');
                    setTimeout(function () {
                        checkAndreturn($('#editor3 > .ql-editor')[0])
                        checkAndreturn($('#editor4 > .ql-editor')[0])
                    }, 500);
                    return;
                }
            });

            checkAndreturn($('#editor4 > .ql-editor')[0])
            checkAndreturn($('#editor5 > .ql-editor')[0])
        }
    });

    var quill5LastText = "";
    quill5.on("text-change", (delta, oldDelta, source) => {
        var text = quill5.getText();
        if (hasOneCharDifference(quill5LastText, quill5.getText())) {
            if (!isWhitespace(getLatestCharacterWithoutNewline(quill5.getText()))) {
                if (quill5.getText(quill5.getSelection().index, 1) == '\n'
                    && quill5.getText(quill5.getSelection().index + 1, 1) != '\n') {
                    quill5LastText = quill5.getText();
                    return;
                }
            }
        }
        quill5LastText = quill5.getText();
        if (source === 'user') {
            delta.ops.forEach(function (op) {
                if (op.insert && op.insert.image) {
                    console.log('insert image');
                    setTimeout(function () {
                        checkAndreturn($('#editor5 > .ql-editor')[0])
                    }, 500);
                    return;
                }
            });

            checkAndreturn($('#editor5 > .ql-editor')[0])
        }
    });
    //   WEBSPELLCHECKER.init({
    //	container: quill.root
    //});
    var toolbar = quill.getModule('toolbar');
    toolbar.addHandler('preview', function () {
        console.log('preview')
    });
    for (item of document.getElementsByClassName('ql-image')) {
        $(item).hide()
    }

    function getLatestCharacterWithoutNewline(text) {
        // Remove trailing newline characters
        text = text.replace(/\n+$/, '');

        // Get the last character
        const lastCharacter = text.slice(-1);

        return lastCharacter;
    }

    function findSingleCharDifference(text1, text2) {
        if (text1.length !== text2.length) {
            return null; // Different lengths, can't have a single character difference.
        }

        for (let i = 0; i < text1.length; i++) {
            if (text1[i] !== text2[i]) {
                if (i + 1 === text1.length) {
                    return text2[i];
                } else {
                    return null; // More than one character difference.
                }
            }
        }

        return null; // No difference found.
    }

    function hasOneCharDifference(text1, text2) {
        if (Math.abs(text1.length - text2.length) == 1) {
            return true; // Different lengths, there must be more than one character difference.
        } else {
            return false;
        }
    }

    //Sapling.init({
    //    key: 'LTL56HSZYX9LQ6QFMWEA6EK30A0ZEJGL',
    //    mode: 'dev',  // NOTE Do not expose API key in production (see https://sapling.ai/docs/sdk/HTML/quickstart/)
    //  });

    //  const contentEditable = document.querySelector('#editor .ql-editor');
    //  //const contentEditable = document.querySelector('#editor2 .ql-editor');
    //  //const contentEditable = document.querySelector('#editor3 .ql-editor');
    //  //const contentEditable = document.querySelector('#editor4 .ql-editor');
    //  //const contentEditable = document.querySelector('#editor5 .ql-editor');
    //  Sapling.observe(contentEditable);


    $('#showMockup').click(function () {
        var x = "height=800px,width=800px;toolbar=0,location=50,menubar=0";
        console.log(x);

        $('.ql-contextmenu').hide();
        var w = window.open('', '_blank', x);
        //var w = window.open('new.html','_blank');
        var style = ".thumbnail {text-align:center} .ql-editor{white-space:pre-wrap!important;height:auto;font-family:Arial!important}p:empty:not(:focus)::before{content:attr(data-placeholder)}img{max-width:352px!important;max-height:210px!important;display:block!important;margin-left:auto!important;margin-right:auto!important}.ql-contextmenu{border:2px solid #cacaca;background:#fff;width:auto}.ql-contextmenu-btn{background-color:#fff!important;z-index:10000;width:98%;text-align:left;display:block;font-size:14px;border:none;padding:3px;margin:3px}button.ql-contextmenu-btn:hover{background-color:#e8e8e9!important}.section-header{margin-top:30px;display:inline-block}i{margin-right:5px}.ql-container{height:auto;min-height:200px}#text .correct{border-bottom:2px solid green}#text .misspelled{border-bottom:2px solid red}u{text-decoration-line:none}body,button,div,h1,h2,h3,h4,h5,h6,img,p,span,svg,u{font-family:Arial!important}p{font-size:14px}p:blank:before{content:'abc'}div.ql-toolbar.ql-snow{border:none!important;display:inline-block}.ql-container.ql-snow{border:none!important}#editor,#editor2{min-height:60px!important;height:auto} body{margin:auto;max-width:770px} #editor > p {white-space:nowrap} #editor2 > p {white-space:nowrap}"

        var htmlPreview = "";
        htmlPreview += "<style>" + style + "</style>" + htmlPreview;
        htmlPreview += `<script>

// Function to open the full-size image
function openFullImage(imageSrc) {
  var newWindow = window.open(imageSrc, '_blank');
 console.log('call')
  if (newWindow) {
    newWindow.focus();
  } else {
    alert('Please allow pop-ups for this site to view the full-size image.');
  }
}

var elementsWithClass = document.getElementsByClassName('open-image');

// Loop through the elements and assign the click event handler
for (var i = 0; i < elementsWithClass.length; i++) {
  elementsWithClass[i].addEventListener('click', function(event) {
    event.preventDefault(); // Prevent default link behavior for anchor tags
    openImageInNewTab(this.href || this.src);
  });
}

<\/script>`;

        htmlPreview += `<p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Version</strong></p>
          <div id="editor">${quill.container.firstChild.innerHTML}</div>
          <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Date</strong></p>
          <div id="editor2">${quill2.container.firstChild.innerHTML}</div>
          <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Summary</strong></p>
          <div id="editor3">${quill3.container.firstChild.innerHTML}</div>
          <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Technical Background</strong></p>
          <div id="editor4">${quill4.container.firstChild.innerHTML}</div>
          <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Resolution</strong></p>
          <div id="editor5">${quill5.container.firstChild.innerHTML}</div>`;
        htmlPreview = extractAndConvertImgsToDivs(htmlPreview);

        w.document.writeln(htmlPreview);

    });

    $('#generateKbi').click(async function () {
        var x = "height=800px,width=800px;toolbar=0,location=50,menubar=0";
        console.log(x);

        $('.ql-contextmenu').hide();
        //var w = window.open('new.html','_blank');
        var style = ".thumbnail {text-align:center} .ql-editor{white-space:pre-wrap!important;height:auto;font-family:Arial!important}p:empty:not(:focus)::before{content:attr(data-placeholder)}img{max-width:352px!important;max-height:210px!important;display:block!important;margin-left:auto!important;margin-right:auto!important}.ql-contextmenu{border:2px solid #cacaca;background:#fff;width:auto}.ql-contextmenu-btn{background-color:#fff!important;z-index:10000;width:98%;text-align:left;display:block;font-size:14px;border:none;padding:3px;margin:3px}button.ql-contextmenu-btn:hover{background-color:#e8e8e9!important}.section-header{margin-top:30px;display:inline-block}i{margin-right:5px}.ql-container{height:auto;min-height:200px}#text .correct{border-bottom:2px solid green}#text .misspelled{border-bottom:2px solid red}u{text-decoration-line:none}body,button,div,h1,h2,h3,h4,h5,h6,img,p,span,svg,u{font-family:Arial!important}p{font-size:14px}p:blank:before{content:'abc'}div.ql-toolbar.ql-snow{border:none!important;display:inline-block}.ql-container.ql-snow{border:none!important}#editor,#editor2{min-height:60px!important;height:auto} body{margin:auto;max-width:770px} #editor > p {white-space:nowrap} #editor2 > p {white-space:nowrap}"

        var htmlPreview = "";
        htmlPreview += "<style>" + style + "</style>" + htmlPreview;
        htmlPreview += `<script>


function openImageInNewTab(XXXX) {
  const newTab = window.open();
console.log(XXXX);
  newTab.document.write(<img src= XXX >);
}

var elementsWithClass = document.getElementsByClassName('open-image');

// Loop through the elements and assign the click event handler
for (var i = 0; i < elementsWithClass.length; i++) {
  elementsWithClass[i].addEventListener('click', function(event) {
    event.preventDefault(); // Prevent default link behavior for anchor tags
    console.log(this);
    openImageInNewTab(this.href || this.src);
  });
}

<\/script>`;

        htmlPreview += `<p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Version</strong></p>
          <div id="editor">${quill.container.firstChild.innerHTML}</div>
          <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Date</strong></p>
          <div id="editor2">${quill2.container.firstChild.innerHTML}</div>
          <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Summary</strong></p>
          <div id="editor3">${quill3.container.firstChild.innerHTML}</div>
          <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Technical Background</strong></p>
          <div id="editor4">${quill4.container.firstChild.innerHTML}</div>
          <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Resolution</strong></p>
          <div id="editor5">${quill5.container.firstChild.innerHTML}</div>`;
        htmlPreview = extractAndConvertImgsToDivs(htmlPreview);
        var kbiName = GenerateKbiName();
        const { htmlString: modifiedHTML, imageFiles } = convertHTMLToFiles(htmlPreview, kbiName);

        await saveFilesWithConfirmation(modifiedHTML, kbiName + '.html', imageFiles);

    });



    //var generateBtn = document.querySelector('.ql-generate');
    //generateBtn.innerHTML = "Generate KBI";
    //generateBtn.addEventListener('click', function () {
    //    var images = img_find();
    //    var html = quill.container.firstChild.innerHTML;
    //    const fd = new FormData();
    //    fd.append('Html', html);
    //    fd.append('Images', images);

    //    const xhr = new XMLHttpRequest();
    //    xhr.open('POST', 'https://c569-184-22-219-255.ngrok-free.app/api/kbi/upload/', true);
    //    xhr.onload = () => {
    //        if (xhr.status === 200) {
    //            var x = JSON.parse(xhr.response);
    //            window.open(x.file.url);
    //             location.reload();
    //        }
    //    };
    //    xhr.send(fd);

    //});
    function isWhitespace(char) {
        return char.trim() === '';
    }

    function endsWithWhitespaceAndNewline(text) {
        const regex = /\s+\n$/;
        return regex.test(text);
    }

    function selectLocalImage() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.click();

        // Listen upload local image and save to server
        input.onchange = () => {
            const file = input.files[0];

            // file type is only image.
            if (/^image\//.test(file.type)) {
                saveToServer(file);
            } else {
                console.warn('You could only upload images');
            }
        };
    }


    /**
     * Step2. save to server
     *
     */
    function saveToServer(file) {
        const fd = new FormData();
        fd.append('image', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://c569-184-22-219-255.ngrok-free.app/api/images/upload', true);
        xhr.onload = () => {
            if (xhr.status === 200) {
                // this is callback data: url
                var x = JSON.parse(xhr.response);
                console.log(x); console.log(x.file);
                insertToEditor(x.file.url);
            }
        };
        xhr.send(fd);
    }

    function img_find() {
        return Array.from(document.getElementsByTagName("img")).map(i => i.src);
    }

    /**
     * Step3. insert image url to rich editor.
     *
     */
    function insertToEditor(url) {
        // push image url to rich editor.
        const range = quill.getSelection();
        console.log(url);
        quill.insertEmbed(range.index, 'image', url);
    }

    // quill editor add image handler
    //quill.getModule('toolbar').addHandler('image', (x) => {
    //   console.log(x);
    //     selectLocalImageAsData();
    //selectLocalImage();
    // });

    //quill.pasteHTML(
    //    "<p style='left:50px;'>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Date</strong></p>" +
    //    "<p>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Summary</strong></p>" +
    //    "<p>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Technical Background</strong></p>" +
    //    "<p>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Resolution</strong></p>" +
    //    "<p class='x'>Your text here<br><br><br><br></p>"
    //);
    var tempState = '';

    function insertImage() {
        if (tempState == 'editor') {
            // $(quill.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor2') {
            // $(quill2.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor3') {
            $(quill3.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor4') {
            $(quill4.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor5') {
            $(quill5.getModule('toolbar').controls[0][1]).click()

        }
    }

    $(document).ready(function () {


        $('.ql-contextmenu').hide();
        //$(document).spellAsYouType();
        document.addEventListener('contextmenu', function (event) {
            event.preventDefault();

            $('#insertImage').show();
            if (document.getElementById('editor').contains(event.target)) {
                tempState = 'editor';
                $('#insertImage').hide();
            }
            else if (document.getElementById('editor2').contains(event.target)) {
                tempState = 'editor2';
                $('#insertImage').hide();
            }
            else if (document.getElementById('editor3').contains(event.target)) {
                tempState = 'editor3';
            }
            else if (document.getElementById('editor4').contains(event.target)) {
                tempState = 'editor4';
            }
            else if (document.getElementById('editor5').contains(event.target)) {
                tempState = 'editor5';
            }
            else {
                tempState = '';
                $('#insertImage').hide();
            }
            const elements = document.getElementsByClassName(tempState);
            var targetElement = null;
            // Loop through the elements and check their positions
            for (let i = 0; i < elements.length; i++) {
                const element = elements[i];
                const rect = element.getBoundingClientRect();

                // Check if the target coordinates are within the bounding box of the element
                if (event.clientX >= rect.left && event.clientX <= rect.right && event.clientY >= rect.top && event.clientY <= rect.bottom) {
                    // The element with the specified class at the target coordinates is found
                    console.log('Found element:', element);
                    targetElement = element;
                    break; // If you want to stop searching after finding the first match
                }
            }
            if (targetElement != null) {
                targetElementText = $(targetElement).data('text');
                $('#ignoreText').show();
                $('#ignoreTextSpan').text('Ignore "' + $(targetElement).data('text') + '"');
                $('#ignoreText').unbind('click');
                console.log(targetElement);
                $('#ignoreText').bind('click', { 'targetElement': targetElement }, ignoreText);

            } else {
                $('#ignoreText').hide();
            }

            if (targetElement != null) {
                $('#addToDict').show();
                $('#addToDictSpan').text('Add "' + $(targetElement).data('text') + '" To Dictionary');
                $('#addToDict').unbind('click');
                $('#addToDict').bind('click', { 'targetElement': targetElement }, addToDictionary);
            } else {
                $('#addToDict').hide();
            }

            const imageElements = document.getElementsByTagName('img');
            var targetImageElements = null;
            // Loop through the elements and check their positions
            for (let i = 0; i < imageElements.length; i++) {
                const element = imageElements[i];
                const rect = element.getBoundingClientRect();

                // Check if the target coordinates are within the bounding box of the element
                if (event.clientX >= rect.left && event.clientX <= rect.right && event.clientY >= rect.top && event.clientY <= rect.bottom) {
                    // The element with the specified class at the target coordinates is found
                    console.log('Found element:', element);
                    targetImageElements = element;
                    break; // If you want to stop searching after finding the first match
                }
            }

            if (targetImageElements != null) {
                $('#deleteImage').show();
                $('#deleteImage').unbind('click');
                $('#deleteImage').bind('click', { 'targetElement': targetImageElements }, deleteImage);
            } else {
                $('#deleteImage').hide();
            }
            $('.ql-contextmenu').css('left', event.clientX);
            $('.ql-contextmenu').css('top', event.clientY);
            $('.ql-contextmenu').css('position', 'fixed');
            $('.ql-contextmenu').css('z-index', 10000);
            $('.ql-contextmenu').show();
        });

        $(document).click(function () {
            //$('div.ql-toolbar').hide();
        });

        $('.ql-underline').hide();

        window.addEventListener('click', function (e) {
            if (document.getElementById('ql-contextmenu').contains(e.target)) {
            } else {
                $('div.ql-contextmenu').hide();
            }
        });
        var ctrlPressed = false;
        var otherPressed = false;
        var delayTimer;
        function check(target) {
            clearTimeout(delayTimer);
            delayTimer = setTimeout(function () {
                checkAndreturn(target);
            }, 200); // Will do the ajax stuff after 1000 ms, or 1 s
        }


        var ctrlKeyDown1 = false;
        $('#editor').on('keyup', function (e) {
            if (event.key === "Enter" || event.keyCode === 13) {
                event.preventDefault();
            }
            if (event.ctrlKey) {
                // do nothing
            } else {
                if (event.key.length === 1) {
                    if (ctrlKeyDown1) {
                        ctrlKeyDown1 = false;
                    } else {
                        //checkAndreturn(e.target);
                    }
                }
            }
        })

        $('#editor').on('keydown', function (e) {
            if (event.key === "Enter" || event.keyCode === 13) {
                event.preventDefault();
            }
            if (event.key === 'Control') {
                ctrlKeyDown1 = true;
            }
        })

        var ctrlKeyDown2 = false;
        $('#editor2').on('keyup', function (e) {
            if (event.key === "Enter" || event.keyCode === 13) {
                event.preventDefault();
            }
            if (event.ctrlKey) {
                // do nothing
            } else {
                if (event.key.length === 1) {
                    if (ctrlKeyDown2) {
                        ctrlKeyDown2 = false;
                    } else {
                        //checkAndreturn(e.target);
                    }
                }
            }
        })

        $('#editor2').on('keydown', function (e) {
            if (event.key === "Enter" || event.keyCode === 13) {
                event.preventDefault();
            }
            if (event.key === 'Control') {
                ctrlKeyDown2 = true;
            }
        })

        //document.getElementById("editor2").addEventListener("input", function () {
        //    spellcheck();
        //}, false);
        //document.getElementById("editor3").addEventListener("input", function () {
        //    spellcheck();
        //}, false);
        //document.getElementById("editor4").addEventListener("input", function () {
        //    spellcheck();
        //}, false);
        //document.getElementById("editor5").addEventListener("input", function () {
        //    spellcheck();
        //}, false);

        //const dictionary = new Typo('en_US');
        //quill.on('text-change', function (delta, oldDelta, source) {
        //    if (source === 'user') {
        //        const text = quill.getText();
        //        const words = text.split(' ');

        //        for (const word of words) {
        //            if (!dictionary.check(word)) {
        //                console.log('xxxxx');
        //            }
        //        }
        //    }
        //});

        const observer = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-value') {
                    const newValue = mutation.target.getAttribute('data-value');
                    var element = $(mutation.target);
                    element.html(newValue.replace('px', '') + element.html().slice(2));
                    // You can perform any actions you want here when the attribute changes.
                }
            }
        });
        const observer2 = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-value') {
                    const newValue = mutation.target.getAttribute('data-value');
                    var element = $(mutation.target);
                    element.html(newValue.replace('px', '') + element.html().slice(2));
                    // You can perform any actions you want here when the attribute changes.
                }
            }
        });
        const observer3 = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-value') {
                    const newValue = mutation.target.getAttribute('data-value');
                    var element = $(mutation.target);
                    element.html(newValue.replace('px', '') + element.html().slice(2));
                    // You can perform any actions you want here when the attribute changes.
                }
            }
        });
        const observer4 = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-value') {
                    const newValue = mutation.target.getAttribute('data-value');
                    var element = $(mutation.target);
                    element.html(newValue.replace('px', '') + element.html().slice(2));
                    // You can perform any actions you want here when the attribute changes.
                }
            }
        });
        const observer5 = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-value') {
                    const newValue = mutation.target.getAttribute('data-value');
                    var element = $(mutation.target);
                    console.log(element.html());
                    element.html(newValue.replace('px', '') + element.html().slice(2));
                    // You can perform any actions you want here when the attribute changes.
                }
            }
        });
        // Configure the observer to watch for attribute changes
        var viewbox = '<svg viewBox="0 0 18 18"><polygon class="ql-stroke" points="3 7 5 9 7 7 3 7"></polygon></svg>';
        const config = { attributes: true, attributeFilter: ['data-value'] };
        var html1 = $($('.ql-size > .ql-picker-label')[0]).html();
        var value1 = $($('.ql-size > .ql-picker-label')[0]).data('value').replace('px', '');
        $($('.ql-size > .ql-picker-label')[0]).html(value1 + '   ' + viewbox);

        var html2 = $($('.ql-size > .ql-picker-label')[1]).html();
        var value2 = $($('.ql-size > .ql-picker-label')[1]).data('value').replace('px', '');
        $($('.ql-size > .ql-picker-label')[1]).html(value2 + '   ' + viewbox);


        var html3 = $($('.ql-size > .ql-picker-label')[2]).html();
        var value3 = $($('.ql-size > .ql-picker-label')[2]).data('value').replace('px', '');
        $($('.ql-size > .ql-picker-label')[2]).html(value3 + '   ' + viewbox);


        var html4 = $($('.ql-size > .ql-picker-label')[3]).html();
        var value4 = $($('.ql-size > .ql-picker-label')[3]).data('value').replace('px', '');
        $($('.ql-size > .ql-picker-label')[3]).html(value4 + '   ' + viewbox);


        var html5 = $($('.ql-size > .ql-picker-label')[4]).html();
        var value5 = $($('.ql-size > .ql-picker-label')[4]).data('value').replace('px', '');
        $($('.ql-size > .ql-picker-label')[4]).html(value5 + '   ' + viewbox);

        // Start observing the target element
        observer.observe($('.ql-size > .ql-picker-label')[0], config);
        observer2.observe($('.ql-size > .ql-picker-label')[1], config);
        observer3.observe($('.ql-size > .ql-picker-label')[2], config);
        observer4.observe($('.ql-size > .ql-picker-label')[3], config);
        observer5.observe($('.ql-size > .ql-picker-label')[4], config);


        // Define the type of mutations to observe
        const configMultiLine = { childList: true, subtree: true };
        var xxx;
        // prevent copy paste multiline
        const observerMultiLine = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === 'childList') {
                    var parent = $(mutation.target);

                    if (parent.find('p').length > 1) {
                        parent.empty();
                    } else {
                        var p = $(parent.find('p'));
                        if (p.text().length > 100) {
                            p.text(p.text().substring(0, 100))
                        }
                    }
                }
            });
        });
        const observerMultiLine2 = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === 'childList') {
                    var parent = $(mutation.target);
                    if (parent.find('p').length > 1) {
                        parent.empty();
                    } else {
                        var p = $(parent.find('p'));
                        if (p.text().length > 100) {
                            p.text(p.text().substring(0, 100))
                        }
                    }
                }
            });
        });
        observerMultiLine.observe($('#editor > .ql-editor')[0], configMultiLine)
        observerMultiLine.observe($('#editor2 > .ql-editor')[0], configMultiLine)



        // Add an event listener for the 'resize' event
        window.addEventListener('resize', handleResize);
    }) // end document ready

    function handleResize() {
        checkAndreturn($('#editor > .ql-editor')[0]);
        checkAndreturn($('#editor2 > .ql-editor')[0]);
        checkAndreturn($('#editor3 > .ql-editor')[0]);
        checkAndreturn($('#editor4 > .ql-editor')[0]);
        checkAndreturn($('#editor5 > .ql-editor')[0]);
    }

    function checkAndreturn(htmlElement) {
        //get current cursor position
        //const sel = window.getSelection();
        //const node = sel.focusNode;
        //const offset = sel.focusOffset;
        //const pos = getCursorPosition(htmlElement, node, offset, { pos: 0, done: false });
        //if (offset === 0) pos.pos += 0.5;
        gg = htmlElement;
        console.log($(htmlElement).parent());
        spellcheck(htmlElement);

        // restore the position
        //sel.removeAllRanges();
        //const range = setCursorPosition(htmlElement, document.createRange(), {
        //    pos: pos.pos,
        //    done: false,
        //});
        //range.collapse(true);
        //sel.addRange(range);
    }
    // get the cursor position from .editor start
    function getCursorPosition(parent, node, offset, stat) {
        if (stat.done) return stat;

        let currentNode = null;
        if (parent.childNodes.length == 0) {
            stat.pos += parent.textContent.length;
        } else {
            for (let i = 0; i < parent.childNodes.length && !stat.done; i++) {
                currentNode = parent.childNodes[i];
                if (currentNode === node) {
                    stat.pos += offset;
                    stat.done = true;
                    return stat;
                } else getCursorPosition(currentNode, node, offset, stat);
            }
        }
        return stat;
    }

    //find the child node and relative position and set it on range
    function setCursorPosition(parent, range, stat) {
        if (stat.done) return range;

        if (parent.childNodes.length == 0) {
            if (parent.textContent.length >= stat.pos) {
                range.setStart(parent, stat.pos);
                stat.done = true;
            } else {
                stat.pos = stat.pos - parent.textContent.length;
            }
        } else {
            for (let i = 0; i < parent.childNodes.length && !stat.done; i++) {
                currentNode = parent.childNodes[i];
                setCursorPosition(currentNode, range, stat);
            }
        }
        return range;
    }

    function setCaretPosition(elemId, caretPos) {
        var elem = document.getElementById(elemId);

        if (elem != null) {
            if (elem.createTextRange) {
                var range = elem.createTextRange();
                range.move('character', caretPos);
                range.select();
            }
            else {
                if (elem.selectionStart) {
                    elem.focus();
                    elem.setSelectionRange(caretPos, caretPos);
                }
                else
                    elem.focus();
            }
        }
    }

    function removeDuplicates(arr) {
        return arr.filter((item,
            index) => arr.indexOf(item) === index);
    }

    var gg;

    function spellcheck(htmlElement) {
        var alreadyProcessWords = [];
        const pattern = /\S+/g;
        gg = htmlElement;
        // gg = $(htmlElement).find(p);
        var p = $(htmlElement).find('p');
        // alreadyProcessWords = [];
        removeDivsByClassName(htmlElement.parentElement.id);
        for (let idx = 0; idx < $(p).length; idx++) {
            //if ($($(p)[idx]).find('img').length) {
            //    continue;
            //}
            // let text = $(p)[idx].innerText.match(pattern);
            let text = $(p)[idx].innerText.split(/(?<=\s)/);
            var html = $(p)[idx].innerText;
            if (text == null) {
                break;
            }
            htmlArray = text.map(function (word) {
                word = word.trim();
                /// if (alreadyProcessWords.includes(word))
                //    return;

                var testword = removeNonAlphanumeric(word);
                var correct = typo.check(testword) || ignoreTextLocal.includes(testword) || isNumeric(testword);

                if (!correct) {
                    //alreadyProcessWords.push(word);
                    var positions = findAllExactTextPositionsOnScreen(word, htmlElement);
                    if (positions != null && positions.length > 0) {
                        positions.forEach((position, index) => {
                            createDivAtPositionWithSize(htmlElement.parentElement.id, word, true, position.x, position.y, position.width, position.height);
                        });
                    }
                }


            });
        }
    }

    function saveFilesWithConfirmation(data, fileName, imageFiles = []) {
        if (window.confirm("Do you want to save these files?")) {
            if (typeof data === 'string') {
                // Create a Blob from the text
                const blob = new Blob([data], { type: 'text/plain' });

                // Create a URL for the Blob
                const url = window.URL.createObjectURL(blob);

                // Create a link element to trigger the download
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;

                // Trigger a click event on the link to initiate the download
                a.click();

                // Release the URL and remove the link element
                window.URL.revokeObjectURL(url);
            } else if (data instanceof File) {
                // Create a URL for the File
                const url = window.URL.createObjectURL(data);

                // Create a link element to trigger the download
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;

                // Trigger a click event on the link to initiate the download
                a.click();

                // Release the URL and remove the link element
                window.URL.revokeObjectURL(url);
            }

            // Download image files
            imageFiles.forEach((imageFile, index) => {
                const url = window.URL.createObjectURL(imageFile);

                const a = document.createElement('a');
                a.href = url;
                a.download = imageFile.name;

                a.click();

                window.URL.revokeObjectURL(url);
            });
        }
    }

    //function saveTextToFileWithConfirmation(text, fileName) {
    //    if (window.confirm("Do you want to save this file?")) {
    //        // Create a Blob from the text
    //        const blob = new Blob([text], { type: 'text/plain' });

    //        // Create a URL for the Blob
    //        const url = window.URL.createObjectURL(blob);

    //        // Create a link element to trigger the download
    //        const a = document.createElement('a');
    //        a.href = url;
    //        a.download = fileName;

    //        // Trigger a click event on the link to initiate the download
    //        a.click();

    //        // Release the URL and remove the link element
    //        window.URL.revokeObjectURL(url);
    //    }
    //}


    function isNumeric(word) {
        // Use a regular expression to test if the word consists of digits only
        return /^\d+$/.test(word);
    }

    function removeNonAlphanumeric(inputString) {
        // Use a regular expression to replace non-alphanumeric characters with an empty string
        return inputString.replace(/[^a-zA-Z0-9]/g, '');
    }

    function replaceNonFormattedText(input) {
        // Use regular expressions to match text within angle brackets and replace non-matching text
        const regex = /<[^>]+>.*?<\/[^>]+>|<([^>]+)>([^<]+)<\/\1>|([^<]+)/g;

        const replacedText = input.replace(regex, function (match, p1, p2, p3) {
            if (p1 && p2) {
                // Matched format <{TAGS}>ANYCHARACTER</TAGS>
                return match;
            } else if (p3) {
                // Non-matching text
                return `<u class="astext">${p3}</u>`;
            } else {
                return match;
            }
        });

        return replacedText;
    }


    function trimSpecialCharacters(inputString) {
        // Use the regular expression to replace the specified characters with an empty string
        var cleanedString = inputString.replace(/[. :;()[\]{}]+$/g, '');
        return cleanedString;
    }
    function escapeRegExp(inputString) {
        // Define a list of characters to escape
        const specialChars = /[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g;

        return inputString.replace(specialChars, '\\$&');
    }


    //function findAllExactTextPositionsOnScreen(targetText) {
    //     targetText = targetText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    //    let textNodes = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
    //    // Use the 'i' flag in the regular expression to make the search case-insensitive
    //    let regex = new RegExp('\\b' + targetText + '\\b', 'gi');
    //    let positions = [];

    //    while (textNodes.nextNode()) {
    //        const matches = [...textNodes.currentNode.textContent.matchAll(regex)];

    //        for (const match of matches) {
    //            const offset = match.index;
    //            const range = document.createRange();
    //            range.setStart(textNodes.currentNode, offset);
    //            range.setEnd(textNodes.currentNode, offset + targetText.length);
    //            const clientRects = range.getClientRects();

    //            if (clientRects.length > 0) {
    //                positions.push({
    //                    x: clientRects[0].left + window.scrollX,
    //                    y: clientRects[0].top + window.scrollY,
    //                    offset: offset,
    //                    width: clientRects[0].width,
    //                    height: clientRects[0].height,
    //                });
    //            }
    //        }
    //    }

    //    return positions;
    //}

    function isNotAlphanumeric(inputString) {
        // Use a regular expression to check for non-alphanumeric characters
        const nonAlphanumericRegex = /[^a-zA-Z0-9]+/;
        return nonAlphanumericRegex.test(inputString);
    }

    function findAllExactTextPositionsOnScreen(targetText, parentElement) {
        let textNodes = document.createTreeWalker(parentElement, NodeFilter.SHOW_TEXT);
        // Escape the targetText for use in a regular expression
        //const escapedText = targetText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const escapedText = targetText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        var regex = null;
        if (isNotAlphanumeric(escapedText)) {
            regex = new RegExp(escapedText, 'gi');
        } else {

            regex = new RegExp('\\b' + escapedText + '\\b', 'gi');
        }
        let positions = [];

        while (textNodes.nextNode()) {
            const matches = [...textNodes.currentNode.textContent.matchAll(regex)];

            for (const match of matches) {
                const offset = match.index;
                const range = document.createRange();
                range.setStart(textNodes.currentNode, offset);
                range.setEnd(textNodes.currentNode, offset + targetText.length);
                const clientRects = range.getClientRects();

                if (clientRects.length > 0) {
                    const parentRect = parentElement.getBoundingClientRect();
                    const textRect = clientRects[0];
                    // Check if the text is within the boundaries of the parent element
                    if (
                        textRect.left >= parentRect.left &&
                        textRect.right <= parentRect.right &&
                        textRect.top >= parentRect.top &&
                        textRect.bottom <= parentRect.bottom
                    ) {
                        positions.push({
                            x: textRect.left + window.scrollX,
                            y: textRect.top + window.scrollY,
                            offset: offset,
                            width: textRect.width,
                            height: textRect.height,
                            parentElement: parentElement,
                        });
                    }
                }
            }
        }

        return positions;
    }



    function removeDivsByClassName(className) {
        var elements = document.getElementsByClassName(className);
        // Convert the HTMLCollection to an array (optional but helpful for looping)
        var elementsArray = Array.from(elements);

        for (var i = 0; i < elementsArray.length; i++) {

            var element = elementsArray[i];
            if ($(element).css('border-bottom').includes('none')) {
                continue;
            }
            element.parentNode.removeChild(element);
        }
    }
    function createDivAtPositionWithSize(parentId, word, mispelled, x, y, width, height) {
        const existingDiv = document.querySelector('.' + parentId + '[data-x="' + x + '"][data-y="' + y + '"]');

        if (existingDiv) {
            // Div with the same position already exists, do not create a new one.
            return;
        }
        // Create a new div element
        var div = document.createElement('div');

        // Set the position and size of the div using CSS
        div.style.position = 'absolute';
        div.style.left = x + 'px';
        div.style.top = y + 'px';
        div.style.width = width + 'px';
        div.style.height = height + 'px';
        div.className = parentId;
        // Add content or styles to the div as needed
        div.style.zIndex = '-100000000';
        div.style.backgroundColor = 'rgba(255, 255, 0, 0.5);';
        div.style.display = 'block';
        div.style.borderBottom = mispelled == true ? '2px solid red' : '2px solid green';
        div.dataset.text = word;
        // Append the div to the document's body
        // Set data attributes to store the position
        div.dataset.x = x;
        div.dataset.y = y;

        document.body.appendChild(div);
    }

    function getSelectedText() {
        var text = '';
        if (window.getSelection) {
            text = window.getSelection().toString();
        } else if (document.selection && document.selection.type != 'Control') {
            text = document.selection.createRange().text;
        }
        return text;
    }

    function ignoreText(event) {
        let targetElement = event.data.targetElement;
        console.log(targetElement);
        $(targetElement).css('border-bottom', 'none');
        $('.ql-contextmenu').hide();
    }
    function addToDictionary(event) {
        let targetElement = event.data.targetElement;
        ignoreTextLocal.push($(targetElement).data('text'));

        localStorage.setItem('ignoreTextLocal', JSON.stringify(ignoreTextLocal));
        $('.ql-contextmenu').hide();
        checkAndreturn($('#editor > .ql-editor')[0]);
        checkAndreturn($('#editor2 > .ql-editor')[0]);
        checkAndreturn($('#editor3 > .ql-editor')[0]);
        checkAndreturn($('#editor4 > .ql-editor')[0]);
        checkAndreturn($('#editor5 > .ql-editor')[0]);
    }

    function deleteImage(event) {
        let targetElement = event.data.targetElement;
        $(targetElement).remove();
        checkAndreturn($('#editor > .ql-editor')[0]);
        checkAndreturn($('#editor2 > .ql-editor')[0]);
        checkAndreturn($('#editor3 > .ql-editor')[0]);
        checkAndreturn($('#editor4 > .ql-editor')[0]);
        checkAndreturn($('#editor5 > .ql-editor')[0]);
        $('.ql-contextmenu').hide();
    }

    function convertImgStringToDivString(imgString) {
        // Create a temporary div element to parse the imgString
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = imgString;

        // Create a div element with the class "thumbnail"
        var divElement = document.createElement('div');
        divElement.className = 'thumbnail';

        // Find the img element within the parsed HTML
        var imgElement = tempDiv.querySelector('img');
        if (imgElement) {
            // Create the anchor tag with the class "imagelink" and "internalimage"
            var imgLink = document.createElement('a');
            imgLink.className = 'imagelink';
            imgLink.href = imgElement.src;
            imgLink.target = '_blank';
            imgLink.rel = 'noopener';
            imgLink.className += "open-image";
            // Clone the img element and add the "async" attribute
            var clonedImg = imgElement.cloneNode(true);
            clonedImg.setAttribute('decoding', 'async');
            clonedImg.className += "open-image";
            // Create the "internalimage" anchor tag
            var internalLink = document.createElement('a');
            internalLink.className = 'internalimage';
            internalLink.href = imgElement.src;
            internalLink.target = '_blank';
            internalLink.rel = 'noopener';
            internalLink.textContent = 'Click For Full Size';
            internalLink.className += "open-image";
            // Append elements to the divElement
            imgLink.appendChild(clonedImg);
            divElement.appendChild(imgLink);
            divElement.appendChild(document.createElement('br'));
            divElement.appendChild(document.createElement('br'));
            divElement.appendChild(internalLink);
            divElement.appendChild(document.createElement('p'));
        }

        // Convert the modified div to an HTML string
        var divString = divElement.outerHTML;

        return divString;
    }

    function extractImgStringsFromHtml(htmlString) {
        var imgStrings = [];

        // Create a temporary div element to parse the HTML string
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlString;

        // Find all img elements within the parsed HTML
        var imgElements = tempDiv.querySelectorAll('img');

        imgElements.forEach(function (imgElement) {
            // Convert each img element to a string and add it to the imgStrings array
            imgStrings.push(imgElement.outerHTML);
        });

        return imgStrings;
    }

    function extractAndConvertImgsToDivs(htmlString) {
        // Step 1: Extract all img tag strings
        var imgTagRegex = /<img[^>]+>/g;
        var imgTags = htmlString.match(imgTagRegex);

        if (!imgTags) {
            return htmlString; // No img tags found, return the original HTML
        }

        // Step 2: Convert each img tag string to the desired div string
        var divStrings = imgTags.map(function (imgTag) {
            return convertImgStringToDivString(imgTag);
        });

        // Step 3: Replace original img tag strings with the new div strings
        for (var i = 0; i < imgTags.length; i++) {
            htmlString = htmlString.replace(imgTags[i], divStrings[i]);
        }

        return htmlString;
    }

    function downloadImage(imageFile, fileName) {
        const blobUrl = URL.createObjectURL(imageFile);

        const downloadLink = document.createElement('a');
        downloadLink.href = blobUrl;
        downloadLink.download = fileName;

        downloadLink.style.display = 'none'; // Hide the link

        document.body.appendChild(downloadLink);

        downloadLink.click();

        document.body.removeChild(downloadLink);

        // Revoke the blob URL after the download
        URL.revokeObjectURL(blobUrl);
    }

    function dataURItoFile(dataURI, fileName) {
        const byteString = atob(dataURI.split(',')[1]);
        const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);

        for (let i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
        }

        const blob = new Blob([ab], { type: mimeString });

        return new File([blob], fileName, { type: mimeString });
    }

    function convertHTMLToFiles(htmlString, filePrefix) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlString, 'text/html');

        // Create a map to store URL-to-file mappings
        const urlToFileMap = new Map();

        // Extract images and anchor tags
        const images = Array.from(doc.querySelectorAll('img'));
        const anchors = Array.from(doc.querySelectorAll('a'));

        // List to store imageFiles
        const imageFiles = [];

        // Function to convert data URI to File
        function dataURItoFile(dataURI, fileName) {
            const byteString = atob(dataURI.split(',')[1]);
            const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);

            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }

            return new File([new Blob([ab], { type: mimeString })], fileName, { type: mimeString });
        }

        // Process images
        images.forEach((img, index) => {
            const dataURI = img.getAttribute('src');
            if (urlToFileMap.has(dataURI)) {
                const fileName = urlToFileMap.get(dataURI);
                img.setAttribute('src', fileName);
            } else {
                const fileName = `${filePrefix}_IMAGE${index + 1}.png`;
                const imageFile = dataURItoFile(dataURI, fileName);
                urlToFileMap.set(dataURI, fileName);
                img.setAttribute('src', fileName);
                imageFiles.push(imageFile); // Add to the list of imageFiles
            }
        });

        // Process anchors
        anchors.forEach((anchor, index) => {
            const dataURI = anchor.getAttribute('href');
            if (urlToFileMap.has(dataURI)) {
                const fileName = urlToFileMap.get(dataURI);
                anchor.setAttribute('href', fileName);
            } else {
                const fileName = `link_${index + 1}.html`;
                const linkFile = dataURItoFile(dataURI, fileName);
                urlToFileMap.set(dataURI, fileName);
                anchor.setAttribute('href', fileName);
            }
        });

        // Serialize the modified document to HTML
        const modifiedHTML = new XMLSerializer().serializeToString(doc);

        return { htmlString: modifiedHTML, imageFiles };
    }

    function GenerateKbiName() {
        return 'ABC' + generateRandomNumericString(3) + "_KBI";
    }

    function generateRandomNumericString(length) {
        let result = '';
        const characters = '0123456789';

        for (let i = 0; i < length; i++) {
            const randomIndex = Math.floor(Math.random() * characters.length);
            result += characters.charAt(randomIndex);
        }

        return result;
    }

    function formatDate(date) {
        const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        const day = daysOfWeek[date.getDay()];
        const dayOfMonth = date.getDate();
        const month = months[date.getMonth()];
        const year = date.getFullYear();

        return `${day}, ${dayOfMonth} ${month} ${year}`;
    }
</script>
