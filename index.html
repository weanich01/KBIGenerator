<!-- Include stylesheet -->
<html>
<head>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/icons-react/dist/index.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    <style type="text/css">


        .ql-snow {
            .ql-picker

        {
            &.ql-size

        {
            .ql-picker-label, .ql-picker-item

        {
            &::before

        {
            content: attr(data-value) !important;
        }

        }
        }
        }
        }

        /* .ql-formats {
            display: block !important;
        }*/

        /* .ql-toolbar {
            box-shadow: inset -1px -1px 100px 100px white;
        }*/

        .ql-container {
            height: 200px;
        }

        .ql-editor {
            font-family: Arial !important;
            white-space: pre-wrap !important;
            /* white-space: pre-wrap !important;
            word-wrap:break-word;*/
        }

        p:empty:not(:focus)::before {
            content: attr(data-placeholder);
        }

        /*.ql-toolbar button {
            width: 150px !important;
            text-align:left!important;
        }*/

        img {
            max-width: 352px !important;
            max-height: 210px !important;
        }

        .ql-contextmenu {
            border: 2px solid #cacaca;
            background: #ffffff;
            width: 160px;
        }

        .ql-contextmenu-btn {
            background-color: white !important;
            z-index: 10000;
            width: 150px;
            text-align: left;
            display: block;
            font-size: 14px;
            border: none;
            padding: 3px;
            margin: 3px;
        }

        button.ql-contextmenu-btn:hover {
            background-color: #E8E8E9 !important;
        }

        .section-header {
            margin-top: 30px;
        }

        i {
            margin-right: 5px;
        }

        .ql-container {
            height: auto;
            min-height: 200px;
        }

        .ql-editor {
            height: auto;
            min-height: 200px;
            font-family: Arial !important;
        }

        #text .correct {
            border-bottom: 2px solid green;
        }

        #text .misspelled {
            border-bottom: 2px solid red;
        }

        u {
            text-decoration-line: none;
        }

        /*.pre {
            white-space: pre-wrap !important;
        }*/
    </style>
    <!-- Create the editor container -->
    <!--<script src="https://svc.webspellchecker.net/spellcheck31/wscbundle/wscbundle.js"></script>-->
    <!--<script>
    window.WEBSPELLCHECKER_CONFIG = {
        "autoSearch": true,
        "autoDestroy": true,
        "autocorrect": true,
        "autocomplete": true,
        "enforceAI": true,
        "serviceId": "1:HA5Gl1-qzT7h2-fOLIO1-jdchR-5nVU13-GYHiI-e9dL33-WIm9B-5G5Oo-898DN-cKJmA2-2t1",
        "serviceProtocol": "https",
        "servicePort": "443",
        "serviceHost": "svc.webspellchecker.net",
        "servicePath": "api"
    }
    </script>-->
    <script src="https://sapling.ai/static/js/sapling-sdk-v1.0.5.min.js"></script>

    <script>

        var typo = null;
        var isRun = false;
        document.addEventListener("DOMContentLoaded", function () {
            const inputText = document.getElementById("input-text");
            const outputText = document.getElementById("output-text");

            typo = new Typo("en_US"); // Create a Typo instance for the English language.


            inputText.addEventListener("input", function () {
                const text = inputText.value;
                const corrections = typo.suggest(text);

                // Display the corrected text in the output element.
                outputText.textContent = corrections[0] || "No suggestions found.";
            });
        });
    </script>

</head>

<body>
    <h1 style="text-align:center">KBI Generator</h1>
    <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Version</strong></p>
    <div id="editor"></div>

    <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Date</strong></p>
    <div id="editor2"></div>
    <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Summary</strong></p>
    <div id="editor3"></div>
    <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Technical Background</strong></p>
    <div id="editor4"></div>
    <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Resolution</strong></p>
    <div id="editor5"></div>

    <div id="ql-contextmenu" class="ql-contextmenu">
        <button class="ql-contextmenu-btn" id="insertImage" onclick="insertImage()">
            <i class="ti ti-photo"></i>Insert Image here.
        </button>
        <button class="ql-contextmenu-btn"><i class="ti ti-presentation"></i>Show Mockup</button>
        <button class="ql-contextmenu-btn"><i class="ti ti-file-export"></i>Generate KBI</button>
    </div>
    <div id="root"></div>
</body>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<!--<script type="text/javascript" src='include.js'></script>-->
<!-- Include the Quill library -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<!--<script type="text/javascript" src="spell.js"></script>-->
<script src="https://cdn.jsdelivr.net/gh/cfinke/Typo.js/typo/typo.js"></script>

<!-- Initialize Quill editor -->
<script>
    //var Size = Quill.import('attributors/style/size');
    //Size.whitelist = ['10px', '12px', '14px', '16px'];
    //Quill.register(Size, true);
    var Size = Quill.import('attributors/style/size');
    Size.whitelist = [
        "10px",
        "12px",
        "14px",
        "16px"
    ];
    //var Block = Quill.import('blots/block');
    //Block.tagName = 'DIV';
    //Block.className = 'pre';
    //Quill.register(Block, true);

    Quill.register(Size, true);
    var toolbarOptions = [
        ['image'],
        // ['preview'],
        //  ['generate'],
        ['bold'],        // toggled buttons
        ['underline'],
        [{
            'size': ["10px",
                "12px",
                "14px",
                "16px"]
        }],  // custom dropdown
        [{ 'color': [] }],

    ];

    var quill = new Quill('#editor', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your text here...',
        theme: 'snow'
    });
    var quill2 = new Quill('#editor2', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your text here...',
        theme: 'snow'
    });
    var quill3 = new Quill('#editor3', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your text here...',
        theme: 'snow'
    });
    var quill4 = new Quill('#editor4', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your text here...',
        theme: 'snow'
    });
    var quill5 = new Quill('#editor5', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your text here...',
        theme: 'snow'
    });
    //   WEBSPELLCHECKER.init({
    //	container: quill.root
    //});
    var toolbar = quill.getModule('toolbar');
    toolbar.addHandler('preview', function () {
        console.log('preview')
    });
    for (item of document.getElementsByClassName('ql-image')) {
        $(item).hide()
    }

    //Sapling.init({
    //    key: 'LTL56HSZYX9LQ6QFMWEA6EK30A0ZEJGL',
    //    mode: 'dev',  // NOTE Do not expose API key in production (see https://sapling.ai/docs/sdk/HTML/quickstart/)
    //  });

    //  const contentEditable = document.querySelector('#editor .ql-editor');
    //  //const contentEditable = document.querySelector('#editor2 .ql-editor');
    //  //const contentEditable = document.querySelector('#editor3 .ql-editor');
    //  //const contentEditable = document.querySelector('#editor4 .ql-editor');
    //  //const contentEditable = document.querySelector('#editor5 .ql-editor');
    //  Sapling.observe(contentEditable);


    //var previewBtn = document.querySelector('.ql-image');
    //previewBtn.innerHTML = "Insert Image Here.";
    //var previewBtn = document.querySelector('.ql-preview');
    //previewBtn.innerHTML = "Show Mockup";
    //previewBtn.addEventListener('click', function () {
    //    var x = "height=800px,width=800px;toolbar=0,location=50,menubar=0";
    //    console.log(x);
    //    var w = window.open('', '_blank', x);
    //    //var w = window.open('new.html','_blank');
    //    w.document.writeln(quill.container.firstChild.innerHTML);

    //});

    //var generateBtn = document.querySelector('.ql-generate');
    //generateBtn.innerHTML = "Generate KBI";
    //generateBtn.addEventListener('click', function () {
    //    var images = img_find();
    //    var html = quill.container.firstChild.innerHTML;
    //    const fd = new FormData();
    //    fd.append('Html', html);
    //    fd.append('Images', images);

    //    const xhr = new XMLHttpRequest();
    //    xhr.open('POST', 'https://c569-184-22-219-255.ngrok-free.app/api/kbi/upload/', true);
    //    xhr.onload = () => {
    //        if (xhr.status === 200) {
    //            var x = JSON.parse(xhr.response);
    //            window.open(x.file.url);
    //             location.reload();
    //        }
    //    };
    //    xhr.send(fd);

    //});

    function selectLocalImage() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.click();

        // Listen upload local image and save to server
        input.onchange = () => {
            const file = input.files[0];

            // file type is only image.
            if (/^image\//.test(file.type)) {
                saveToServer(file);
            } else {
                console.warn('You could only upload images.');
            }
        };
    }


    /**
     * Step2. save to server
     *
     */
    function saveToServer(file) {
        const fd = new FormData();
        fd.append('image', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://c569-184-22-219-255.ngrok-free.app/api/images/upload', true);
        xhr.onload = () => {
            if (xhr.status === 200) {
                // this is callback data: url
                var x = JSON.parse(xhr.response);
                console.log(x); console.log(x.file);
                insertToEditor(x.file.url);
            }
        };
        xhr.send(fd);
    }

    function img_find() {
        return Array.from(document.getElementsByTagName("img")).map(i => i.src);
    }

    /**
     * Step3. insert image url to rich editor.
     *
     */
    function insertToEditor(url) {
        // push image url to rich editor.
        const range = quill.getSelection();
        console.log(url);
        quill.insertEmbed(range.index, 'image', url);
    }

    // quill editor add image handler
    //quill.getModule('toolbar').addHandler('image', (x) => {
    //   console.log(x);
    //     selectLocalImageAsData();
    //selectLocalImage();
    // });

    //quill.pasteHTML(
    //    "<p style='left:50px;'>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Date</strong></p>" +
    //    "<p>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Summary</strong></p>" +
    //    "<p>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Technical Background</strong></p>" +
    //    "<p>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Resolution</strong></p>" +
    //    "<p class='x'>Your text here<br><br><br><br></p>"
    //);
    var tempState = '';

    function insertImage() {
        if (tempState == 'editor') {
            $(quill.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor2') {
            $(quill2.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor3') {
            $(quill3.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor4') {
            $(quill4.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor5') {
            $(quill5.getModule('toolbar').controls[0][1]).click()
        }
    }
    $(document).ready(function () {
        $('.ql-contextmenu').hide();
        //$(document).spellAsYouType();
        document.addEventListener('contextmenu', function (event) {
            event.preventDefault();

            $('#insertImage').show();
            if (document.getElementById('editor').contains(event.target)) {
                tempState = 'editor';
            }
            else if (document.getElementById('editor2').contains(event.target)) {
                tempState = 'editor2';
            }
            else if (document.getElementById('editor3').contains(event.target)) {
                tempState = 'editor3';
            }
            else if (document.getElementById('editor4').contains(event.target)) {
                tempState = 'editor4';
            }
            else if (document.getElementById('editor5').contains(event.target)) {
                tempState = 'editor5';
            }
            else {
                tempState = '';
                $('#insertImage').hide();
            }
            $('.ql-contextmenu').css('left', event.clientX);
            $('.ql-contextmenu').css('top', event.clientY);
            $('.ql-contextmenu').css('position', 'fixed');
            $('.ql-contextmenu').css('z-index', 10000);
            $('.ql-contextmenu').show();
        });

        $(document).click(function () {
            //$('div.ql-toolbar').hide();
        });

        $('.ql-underline').hide();

        window.addEventListener('click', function (e) {
            if (document.getElementById('ql-contextmenu').contains(e.target)) {
            } else {
                $('div.ql-contextmenu').hide();
            }
        });

        $('#editor').on('keyup', function (e) {
            if (e.ctrlKey) {
                return;
            }
            if (e.keyCode != 32) {
                console.log(e.keyCode);
                checkAndreturn(e.target);
            }
        })
        
        //document.getElementById("editor2").addEventListener("input", function () {
        //    spellcheck();
        //}, false);
        //document.getElementById("editor3").addEventListener("input", function () {
        //    spellcheck();
        //}, false);
        //document.getElementById("editor4").addEventListener("input", function () {
        //    spellcheck();
        //}, false);
        //document.getElementById("editor5").addEventListener("input", function () {
        //    spellcheck();
        //}, false);

        //const dictionary = new Typo('en_US');
        //quill.on('text-change', function (delta, oldDelta, source) {
        //    if (source === 'user') {
        //        const text = quill.getText();
        //        const words = text.split(' ');

        //        for (const word of words) {
        //            if (!dictionary.check(word)) {
        //                console.log('xxxxx');
        //            }
        //        }
        //    }
        //});
    })
    function checkAndreturn(htmlElement) {
            //get current cursor position
            const sel = window.getSelection();
            const node = sel.focusNode;
            const offset = sel.focusOffset;
            const pos = getCursorPosition(editor, node, offset, { pos: 0, done: false });
            console.log(pos);
            if (offset === 0) pos.pos += 0.5;

            spellcheck(htmlElement);

            // restore the position
            sel.removeAllRanges();
            const range = setCursorPosition(editor, document.createRange(), {
                pos: pos.pos,
                done: false,
            });
            range.collapse(true);
            sel.addRange(range);
        }
    // get the cursor position from .editor start
    function getCursorPosition(parent, node, offset, stat) {
        if (stat.done) return stat;

        let currentNode = null;
        if (parent.childNodes.length == 0) {
            stat.pos += parent.textContent.length;
        } else {
            for (let i = 0; i < parent.childNodes.length && !stat.done; i++) {
                currentNode = parent.childNodes[i];
                if (currentNode === node) {
                    stat.pos += offset;
                    stat.done = true;
                    return stat;
                } else getCursorPosition(currentNode, node, offset, stat);
            }
        }
        return stat;
    }

    //find the child node and relative position and set it on range
    function setCursorPosition(parent, range, stat) {
        if (stat.done) return range;

        if (parent.childNodes.length == 0) {
            if (parent.textContent.length >= stat.pos) {
                range.setStart(parent, stat.pos);
                stat.done = true;
            } else {
                stat.pos = stat.pos - parent.textContent.length;
            }
        } else {
            for (let i = 0; i < parent.childNodes.length && !stat.done; i++) {
                currentNode = parent.childNodes[i];
                setCursorPosition(currentNode, range, stat);
            }
        }
        return range;
    }

    function setCaretPosition(elemId, caretPos) {
        var elem = document.getElementById(elemId);

        if (elem != null) {
            if (elem.createTextRange) {
                var range = elem.createTextRange();
                range.move('character', caretPos);
                range.select();
            }
            else {
                if (elem.selectionStart) {
                    elem.focus();
                    elem.setSelectionRange(caretPos, caretPos);
                }
                else
                    elem.focus();
            }
        }
    }

    function removeDuplicates(arr) {
        return arr.filter((item,
            index) => arr.indexOf(item) === index);
    }

    var gg;
    function spellcheck(htmlElement) {
        const pattern = /\S+/g;
        gg = htmlElement;
        // gg = $(htmlElement).find(p);
        var p = $(htmlElement).find('p');
        for (let idx = 0; idx < $(p).length; idx++) {
            // let text = $(p)[idx].innerText.match(pattern);
            let text = $(p)[idx].innerText.split(/(?<=\s)/);
            var html = $(p)[idx].innerText;
            if (text == null) {
                break;
            }
            //text = removeDuplicates(text);
            //for (let idx2 = 0; idx2 < text.length; idx2++) {
            //    if (typo.check(text[idx2]) == false) {
            //        console.log("html=");
            //        console.log(html);
            //        console.log("replace=");
            //        console.log(text[idx2]);
            //        console.log("with=");
            //        console.log('<span style="color:red"> ' + text[idx2] + "</span>");
            //        html = html.replaceAll(text[idx2], '<span style="color:red"> ' + text[idx2] + "</span>");
            //    } else {
            //        html = html;
            //    }
            //    console.log(html);
            //}
            html = text.map(function (word) {
                var correct = typo.check(word.trim());
                var className = correct ? 'border-bottom: 2px solid green;' : 'text-decoration-line: none;border-bottom: 2px solid red;';
               
                return `<u style="${className}">${word.trim()}</u>`;

            }).join(' ');
            $($(p)[idx]).html(html + ' ');
            html = "";
        }
    }
</script>
