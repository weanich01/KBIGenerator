<!-- Include stylesheet -->
<html>
<head>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/arial-2" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/icons-react/dist/index.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    <style type="text/css">


        .ql-snow {
            .ql-picker

        {
            &.ql-size

        {
            .ql-picker-label, .ql-picker-item

        {
            &::before

        {
            content: '' !important;
        }

        }
        }
        }
        }

        /*.ql-size > .ql-picker-label::after {
            content: '\2304'
        }*/
        /* .ql-formats {
            display: block !important;
        }*/
        /* .ql-toolbar {
            box-shadow: inset -1px -1px 100px 100px white;
        }*/
        .ql-container {
            height: 200px;
        }

        .ql-editor {
            font-family: Arial !important;
            white-space: pre-wrap !important;
            /* white-space: pre-wrap !important;*/
            /* word-wrap:break-word;*/
        }

        p:empty:not(:focus)::before {
            content: attr(data-placeholder);
        }

        /*.ql-toolbar button {
            width: 150px !important;
            text-align:left!important;
        }*/

        img {
            max-width: 352px !important;
            max-height: 210px !important;
        }

        .ql-contextmenu {
            border: 2px solid #cacaca;
            background: #ffffff;
            width: auto;
        }

        .ql-contextmenu-btn {
            background-color: white !important;
            z-index: 10000;
            width: 98%;
            text-align: left;
            display: block;
            font-size: 14px;
            border: none;
            padding: 3px;
            margin: 3px;
        }

        button.ql-contextmenu-btn:hover {
            background-color: #E8E8E9 !important;
        }

        .section-header {
            margin-top: 30px;
        }

        i {
            margin-right: 5px;
        }

        .ql-container {
            height: auto;
            min-height: 200px;
        }

        .ql-editor {
            height: auto;
            font-family: Arial !important;
        }

        #text .correct {
            border-bottom: 2px solid green;
        }

        #text .misspelled {
            border-bottom: 2px solid red;
        }

        u {
            text-decoration-line: none;
        }

        body, button, span, svg, div, img, h1, h2, h3, h4, h5, h6, p, u {
            font-family: Aerial !important;
        }

        p {
            font-size: 14px;
        }

            p:blank:before {
                content: 'abc';
            }

        div.ql-toolbar.ql-snow {
            border: none !important;
            display: inline-block;
        }

        .section-header {
            display: inline-block;
        }

        .ql-container.ql-snow {
            border: none !important;
        }

        #editor, #editor2 {
            min-height: 60px !important;
            height: auto;
        }

        .ql-picker.ql-size .ql-picker-item[data-value="10px"]::before {
            content: '10' !important;
        }

        .ql-picker.ql-size .ql-picker-item[data-value="12px"]::before {
            content: '12' !important;
        }

        .ql-picker.ql-size .ql-picker-item[data-value="14px"]::before {
            content: '14' !important;
        }

        .ql-picker.ql-size .ql-picker-item[data-value="16px"]::before {
            content: '16' !important;
        }

        /* set font-size picker */
        .ql-size {
            width: 30px !important;
            font-size:12px!important;
        }

            .ql-size > .ql-picker-label {
                width: 40px !important;
                padding: 3px 5px !important;
                border: 1px solid black !important;
            }

            .ql-size > .ql-picker-options {
                width: 40px !important;
                border: 1px solid black !important;
                padding:0px!important;
                
            }

            .ql-size > .ql-picker-options > .ql-picker-item {
                width: 100%!important;
                display:block!important;
                text-align:center
            }

                .ql-size > .ql-picker-options > .ql-picker-item:hover {
                    width: 100% !important;
                    display: block !important;
                    text-align: center;
                    background-color: rgb(29,139,245);
                    color:white;
                    
                }
        .ql-snow .ql-picker:not(.ql-color-picker):not(.ql-icon-picker) svg {
            /*right:3px!important*/
        
        }

        .ql-formats{
            margin-right:0px!important;
        }

        .ql-color{
            margin-left:14px;
        }
        /* end set font-size picker*/
        /*.pre {
            white-space: pre-wrap !important;
        }*/
    </style>
    <!-- Create the editor container -->
    <!--<script src="https://svc.webspellchecker.net/spellcheck31/wscbundle/wscbundle.js"></script>-->
    <!--<script>
    window.WEBSPELLCHECKER_CONFIG = {
        "autoSearch": true,
        "autoDestroy": true,
        "autocorrect": true,
        "autocomplete": true,
        "enforceAI": true,
        "serviceId": "1:HA5Gl1-qzT7h2-fOLIO1-jdchR-5nVU13-GYHiI-e9dL33-WIm9B-5G5Oo-898DN-cKJmA2-2t1",
        "serviceProtocol": "https",
        "servicePort": "443",
        "serviceHost": "svc.webspellchecker.net",
        "servicePath": "api"
    }
    </script>-->
    <script src="https://sapling.ai/static/js/sapling-sdk-v1.0.5.min.js"></script>

    <script>
        var ignoreTextLocal = [];
        if (localStorage.getItem('ignoreTextLocal') == null) {
            localStorage.setItem('ignoreTextLocal', JSON.stringify(ignoreTextLocal));
        } else {
            ignoreTextLocal = JSON.parse(localStorage.getItem('ignoreTextLocal'));
        }
        var typo = null;
        var isRun = false;
        document.addEventListener("DOMContentLoaded", function () {
            const inputText = document.getElementById("input-text");
            const outputText = document.getElementById("output-text");

            typo = new Typo("en_US"); // Create a Typo instance for the English language.


            //inputText.addEventListener("input", function () {
            //    const text = inputText.value;
            //    const corrections = typo.suggest(text);

            //    // Display the corrected text in the output element.
            //    outputText.textContent = corrections[0] || "No suggestions found.";
            //});
        });
    </script>

</head>

<body>
    <h1 style="text-align:center">KBI Generator</h1>
    <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Version</strong></p>
    <div id="editor"></div>
    <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Date</strong></p>
    <div id="editor2"></div>
    <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Summary</strong></p>
    <div id="editor3"></div>
    <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Technical Background</strong></p>
    <div id="editor4"></div>
    <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Resolution</strong></p>
    <div id="editor5"></div>

    <div id="ql-contextmenu" class="ql-contextmenu">
        <button class="ql-contextmenu-btn" id="ignoreText">
            <i class="ti ti-vocabulary"></i><span id="ignoreTextSpan"></span>
        </button>
        <button class="ql-contextmenu-btn" id="addToDict">
            <i class="ti ti-vocabulary"></i><span id="addToDictSpan"></span>
        </button>
        <button class="ql-contextmenu-btn" id="deleteImage">
            <i class="ti ti-photo"></i><span>Delete Image</span>
        </button>
        <button class="ql-contextmenu-btn" id="insertImage" onclick="insertImage()">
            <i class="ti ti-photo"></i>Insert Image Here
        </button>
        <button id="showMockup" class="ql-contextmenu-btn"><i class="ti ti-presentation"></i>Show Mockup</button>
        <button class="ql-contextmenu-btn"><i class="ti ti-file-export"></i>Generate KBI</button>
    </div>
    <div id="root"></div>
</body>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<!--<script type="text/javascript" src='include.js'></script>-->
<!-- Include the Quill library -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<!--<script type="text/javascript" src="spell.js"></script>-->
<script src="https://cdn.jsdelivr.net/gh/cfinke/Typo.js/typo/typo.js"></script>

<!-- Initialize Quill editor -->
<script>
    //var Size = Quill.import('attributors/style/size');
    //Size.whitelist = ['10px', '12px', '14px', '16px'];
    //Quill.register(Size, true);
    var Size = Quill.import('attributors/style/size');
    Size.whitelist = [
        "10px",
        "12px",
        "14px",
        "16px"
    ];
    //var Block = Quill.import('blots/block');
    //Block.tagName = 'DIV';
    //Block.className = 'pre';
    //Quill.register(Block, true);

    Quill.register(Size, true);
    let Inline = Quill.import('blots/inline');

    var icons = Quill.import('ui/icons');
    icons['bold'] = '<strong>B</strong>';
    console.log(icons['color']);
    //icons['color'] = ' A<line class="ql-color-label ql-stroke ql-transparent" x1=3 x2=15 y1=15 y2=15></line> <polyline class=ql-stroke points="5.5 11 9 3 12.5 11"></polyline> <line class=ql-stroke x1=11.63 x2=6.38 y1=9 y2=9></line>'
    icons['color'] = `
<div style="display: block;position: relative;top: 0;left: 0;">A</div>
<svg viewBox="0 0 18 18" style="position:relative;top:-15px;">
<line class="ql-color-label ql-stroke ql-transparent" x1="3" x2="15" y1="15" y2="15" style=""></line>  <line class="" x1="11.63" x2="6.38" y1="9" y2="9"></line> </svg>`

    class ctBlot extends Inline { }
    ctBlot.blotName = 'ct';
    ctBlot.tagName = 'ct';

    Quill.register(ctBlot);
    var toolbarOptions = [
         ['underline'],
        // ['preview'],
        //  ['generate'],
        ['bold'],        // toggled buttons
       
        [{
            'size': ["10px",
                "12px",
                "14px",
                "16px"]
        }],  // custom dropdown
        ['image'],
        [{ 'color': [] }],

    ];
    var formatWhitelist = ['bold', 'underline'];
    var quill = new Quill('#editor', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your Text Here',
        theme: 'snow'
    });
    quill.getModule('keyboard').bindings[13] = null;
    var quill2 = new Quill('#editor2', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your Text Here',
        theme: 'snow'
    });
    quill2.getModule('keyboard').bindings[13] = null;
    var quill3 = new Quill('#editor3', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your Text Here',
        theme: 'snow',
    });
    var quill4 = new Quill('#editor4', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your Text Here',
        theme: 'snow'
    });
    var quill5 = new Quill('#editor5', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your Text Here',
        theme: 'snow'
    });


    //   WEBSPELLCHECKER.init({
    //	container: quill.root
    //});
    var toolbar = quill.getModule('toolbar');
    toolbar.addHandler('preview', function () {
        console.log('preview')
    });
    for (item of document.getElementsByClassName('ql-image')) {
        $(item).hide()
    }

    //Sapling.init({
    //    key: 'LTL56HSZYX9LQ6QFMWEA6EK30A0ZEJGL',
    //    mode: 'dev',  // NOTE Do not expose API key in production (see https://sapling.ai/docs/sdk/HTML/quickstart/)
    //  });

    //  const contentEditable = document.querySelector('#editor .ql-editor');
    //  //const contentEditable = document.querySelector('#editor2 .ql-editor');
    //  //const contentEditable = document.querySelector('#editor3 .ql-editor');
    //  //const contentEditable = document.querySelector('#editor4 .ql-editor');
    //  //const contentEditable = document.querySelector('#editor5 .ql-editor');
    //  Sapling.observe(contentEditable);


    $('#showMockup').click(function () {
        var x = "height=800px,width=800px;toolbar=0,location=50,menubar=0";
        console.log(x);

        $('.ql-contextmenu').hide();
        var w = window.open('', '_blank', x);
        //var w = window.open('new.html','_blank');
        var style = ".thumbnail {text-align:center} .ql-editor{white-space:pre-wrap!important;height:auto;font-family:Arial!important}p:empty:not(:focus)::before{content:attr(data-placeholder)}img{max-width:352px!important;max-height:210px!important;display:block!important;margin-left:auto!important;margin-right:auto!important}.ql-contextmenu{border:2px solid #cacaca;background:#fff;width:auto}.ql-contextmenu-btn{background-color:#fff!important;z-index:10000;width:98%;text-align:left;display:block;font-size:14px;border:none;padding:3px;margin:3px}button.ql-contextmenu-btn:hover{background-color:#e8e8e9!important}.section-header{margin-top:30px;display:inline-block}i{margin-right:5px}.ql-container{height:auto;min-height:200px}#text .correct{border-bottom:2px solid green}#text .misspelled{border-bottom:2px solid red}u{text-decoration-line:none}body,button,div,h1,h2,h3,h4,h5,h6,img,p,span,svg,u{font-family:Aerial!important}p{font-size:14px}p:blank:before{content:'abc'}div.ql-toolbar.ql-snow{border:none!important;display:inline-block}.ql-container.ql-snow{border:none!important}#editor,#editor2{min-height:60px!important;height:auto}"

        var htmlPreview = "";
        htmlPreview += "<style>" + style + "</style>" + htmlPreview;
        htmlPreview += `<script>

// Function to open the full-size image
function openFullImage(imageSrc) {
  var newWindow = window.open(imageSrc, '_blank');
 console.log('call')
  if (newWindow) {
    newWindow.focus();
  } else {
    alert('Please allow pop-ups for this site to view the full-size image.');
  }
}

var elementsWithClass = document.getElementsByClassName('open-image');

// Loop through the elements and assign the click event handler
for (var i = 0; i < elementsWithClass.length; i++) {
  elementsWithClass[i].addEventListener('click', function(event) {
    event.preventDefault(); // Prevent default link behavior for anchor tags
    openFullImage(this.href || this.src);
  });
}

<\/script>`;

        htmlPreview += `<p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Version</strong></p>
          <div id="editor">${quill.container.firstChild.innerHTML}</div>
          <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Date</strong></p>
          <div id="editor2">${quill2.container.firstChild.innerHTML}</div>
          <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Summary</strong></p>
          <div id="editor3">${quill3.container.firstChild.innerHTML}</div>
          <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Technical Background</strong></p>
          <div id="editor4">${quill4.container.firstChild.innerHTML}</div>
          <p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Resolution</strong></p>
          <div id="editor5">${quill5.container.firstChild.innerHTML}</div>`;
        htmlPreview = extractAndConvertImgsToDivs(htmlPreview);

        w.document.writeln(htmlPreview);

    });



    //var generateBtn = document.querySelector('.ql-generate');
    //generateBtn.innerHTML = "Generate KBI";
    //generateBtn.addEventListener('click', function () {
    //    var images = img_find();
    //    var html = quill.container.firstChild.innerHTML;
    //    const fd = new FormData();
    //    fd.append('Html', html);
    //    fd.append('Images', images);

    //    const xhr = new XMLHttpRequest();
    //    xhr.open('POST', 'https://c569-184-22-219-255.ngrok-free.app/api/kbi/upload/', true);
    //    xhr.onload = () => {
    //        if (xhr.status === 200) {
    //            var x = JSON.parse(xhr.response);
    //            window.open(x.file.url);
    //             location.reload();
    //        }
    //    };
    //    xhr.send(fd);

    //});

    function selectLocalImage() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.click();

        // Listen upload local image and save to server
        input.onchange = () => {
            const file = input.files[0];

            // file type is only image.
            if (/^image\//.test(file.type)) {
                saveToServer(file);
            } else {
                console.warn('You could only upload images');
            }
        };
    }


    /**
     * Step2. save to server
     *
     */
    function saveToServer(file) {
        const fd = new FormData();
        fd.append('image', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://c569-184-22-219-255.ngrok-free.app/api/images/upload', true);
        xhr.onload = () => {
            if (xhr.status === 200) {
                // this is callback data: url
                var x = JSON.parse(xhr.response);
                console.log(x); console.log(x.file);
                insertToEditor(x.file.url);
            }
        };
        xhr.send(fd);
    }

    function img_find() {
        return Array.from(document.getElementsByTagName("img")).map(i => i.src);
    }

    /**
     * Step3. insert image url to rich editor.
     *
     */
    function insertToEditor(url) {
        // push image url to rich editor.
        const range = quill.getSelection();
        console.log(url);
        quill.insertEmbed(range.index, 'image', url);
    }

    // quill editor add image handler
    //quill.getModule('toolbar').addHandler('image', (x) => {
    //   console.log(x);
    //     selectLocalImageAsData();
    //selectLocalImage();
    // });

    //quill.pasteHTML(
    //    "<p style='left:50px;'>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Date</strong></p>" +
    //    "<p>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Summary</strong></p>" +
    //    "<p>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Technical Background</strong></p>" +
    //    "<p>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Resolution</strong></p>" +
    //    "<p class='x'>Your text here<br><br><br><br></p>"
    //);
    var tempState = '';

    function insertImage() {
        if (tempState == 'editor') {
            $(quill.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor2') {
            $(quill2.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor3') {
            $(quill3.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor4') {
            $(quill4.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor5') {
            $(quill5.getModule('toolbar').controls[0][1]).click()
        }
    }

    $(document).ready(function () {



        $('.ql-contextmenu').hide();
        //$(document).spellAsYouType();
        document.addEventListener('contextmenu', function (event) {
            event.preventDefault();

            $('#insertImage').show();
            if (document.getElementById('editor').contains(event.target)) {
                tempState = 'editor';
            }
            else if (document.getElementById('editor2').contains(event.target)) {
                tempState = 'editor2';
            }
            else if (document.getElementById('editor3').contains(event.target)) {
                tempState = 'editor3';
            }
            else if (document.getElementById('editor4').contains(event.target)) {
                tempState = 'editor4';
            }
            else if (document.getElementById('editor5').contains(event.target)) {
                tempState = 'editor5';
            }
            else {
                tempState = '';
                $('#insertImage').hide();
            }
            const elements = document.getElementsByClassName(tempState);
            var targetElement = null;
            // Loop through the elements and check their positions
            for (let i = 0; i < elements.length; i++) {
                const element = elements[i];
                const rect = element.getBoundingClientRect();

                // Check if the target coordinates are within the bounding box of the element
                if (event.clientX >= rect.left && event.clientX <= rect.right && event.clientY >= rect.top && event.clientY <= rect.bottom) {
                    // The element with the specified class at the target coordinates is found
                    console.log('Found element:', element);
                    targetElement = element;
                    break; // If you want to stop searching after finding the first match
                }
            }
            if (targetElement != null) {
                targetElementText = $(targetElement).data('text');
                $('#ignoreText').show();
                $('#ignoreTextSpan').text('Ignore "' + $(targetElement).data('text') + '"');
                $('#ignoreText').unbind('click');
                console.log(targetElement);
                $('#ignoreText').bind('click', { 'targetElement': targetElement }, ignoreText);

            } else {
                $('#ignoreText').hide();
            }

            if (targetElement != null) {
                $('#addToDict').show();
                $('#addToDictSpan').text('Add "' + $(targetElement).data('text') + '" To Dictionary');
                $('#addToDict').unbind('click');
                $('#addToDict').bind('click', { 'targetElement': targetElement }, addToDictionary);
            } else {
                $('#addToDict').hide();
            }

            const imageElements = document.getElementsByTagName('img');
            var targetImageElements = null;
            // Loop through the elements and check their positions
            for (let i = 0; i < imageElements.length; i++) {
                const element = imageElements[i];
                const rect = element.getBoundingClientRect();

                // Check if the target coordinates are within the bounding box of the element
                if (event.clientX >= rect.left && event.clientX <= rect.right && event.clientY >= rect.top && event.clientY <= rect.bottom) {
                    // The element with the specified class at the target coordinates is found
                    console.log('Found element:', imageElements);
                    targetImageElements = imageElements;
                    break; // If you want to stop searching after finding the first match
                }
            }

            if (targetImageElements != null) {
                $('#deleteImage').show();
                $('#deleteImage').unbind('click');
                $('#deleteImage').bind('click', { 'targetElement': targetImageElements }, deleteImage);
            } else {
                $('#deleteImage').hide();
            }
            $('.ql-contextmenu').css('left', event.clientX);
            $('.ql-contextmenu').css('top', event.clientY);
            $('.ql-contextmenu').css('position', 'fixed');
            $('.ql-contextmenu').css('z-index', 10000);
            $('.ql-contextmenu').show();
        });

        $(document).click(function () {
            //$('div.ql-toolbar').hide();
        });

        $('.ql-underline').hide();

        window.addEventListener('click', function (e) {
            if (document.getElementById('ql-contextmenu').contains(e.target)) {
            } else {
                $('div.ql-contextmenu').hide();
            }
        });
        var ctrlPressed = false;
        var otherPressed = false;
        var delayTimer;
        function check(target) {
            clearTimeout(delayTimer);
            delayTimer = setTimeout(function () {
                checkAndreturn(target);
            }, 200); // Will do the ajax stuff after 1000 ms, or 1 s
        }

        $('#editor').on('keyup', function (e) {
            if (e.keyCode == 13) {
                return;
            }
            if (e.keyCode == 17) {
                ctrlPressed = false;
            } else {
                if (!ctrlPressed) {
                    checkAndreturn(e.target);
                }
            }
        })

        $('#editor').on('keydown', function (e) {
            if (e.keyCode == 17) {
                ctrlPressed = true;
            }
        })

        $('#editor2').on('keyup', function (e) {
            if (e.keyCode == 13) {
                return;
            }
            if (e.keyCode == 17) {
                ctrlPressed = false;
            } else {
                if (!ctrlPressed) {
                    checkAndreturn(e.target);
                }
            }
        })

        $('#editor2').on('keydown', function (e) {
            if (e.keyCode == 17) {
                ctrlPressed = true;
            }
        })


        $('#editor3').on('keyup', function (e) {
            if (e.keyCode == 13) {
                return;
            }
            checkAndreturn(e.target);
            //if (e.keyCode == 17) {
            //    ctrlPressed = false;
            //} else {
            //    if (!ctrlPressed) {
            //        checkAndreturn(e.target);
            //    }
            //}
        })

        $('#editor3').on('keydown', function (e) {
            if (e.keyCode == 17) {
                ctrlPressed = true;
            }
        })
        $('#editor4').on('keyup', function (e) {
            if (e.keyCode == 13) {
                return;
            }
            if (e.keyCode == 17) {
                ctrlPressed = false;
            } else {
                if (!ctrlPressed) {
                    checkAndreturn(e.target);
                }
            }
        })

        $('#editor4').on('keydown', function (e) {
            if (e.keyCode == 17) {
                ctrlPressed = true;
            }
        })

        $('#editor5').on('keyup', function (e) {
            if (e.keyCode == 13) {
                return;
            }
            if (e.keyCode == 17) {
                ctrlPressed = false;
            } else {
                if (!ctrlPressed) {
                    checkAndreturn(e.target);
                }
            }
        })

        $('#editor5').on('keydown', function (e) {
            if (e.keyCode == 17) {
                ctrlPressed = true;
            }
        })
        //document.getElementById("editor2").addEventListener("input", function () {
        //    spellcheck();
        //}, false);
        //document.getElementById("editor3").addEventListener("input", function () {
        //    spellcheck();
        //}, false);
        //document.getElementById("editor4").addEventListener("input", function () {
        //    spellcheck();
        //}, false);
        //document.getElementById("editor5").addEventListener("input", function () {
        //    spellcheck();
        //}, false);

        //const dictionary = new Typo('en_US');
        //quill.on('text-change', function (delta, oldDelta, source) {
        //    if (source === 'user') {
        //        const text = quill.getText();
        //        const words = text.split(' ');

        //        for (const word of words) {
        //            if (!dictionary.check(word)) {
        //                console.log('xxxxx');
        //            }
        //        }
        //    }
        //});

        const observer = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-value') {
                    const newValue = mutation.target.getAttribute('data-value');
                    console.log(`data-value changed to: ${newValue}`);
                    var element = $(mutation.target);
                    element.html(newValue.replace('px', '') + element.html().slice(2));
                    // You can perform any actions you want here when the attribute changes.
                }
            }
        });
        const observer2 = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-value') {
                    const newValue = mutation.target.getAttribute('data-value');
                    console.log(`data-value changed to: ${newValue}`);
                    var element = $(mutation.target);
                    element.html(newValue.replace('px', '') + element.html().slice(2));
                    // You can perform any actions you want here when the attribute changes.
                }
            }
        });
        const observer3 = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-value') {
                    const newValue = mutation.target.getAttribute('data-value');
                    console.log(`data-value changed to: ${newValue}`);
                    var element = $(mutation.target);
                    element.html(newValue.replace('px', '') + element.html().slice(2));
                    // You can perform any actions you want here when the attribute changes.
                }
            }
        });
        const observer4 = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-value') {
                    const newValue = mutation.target.getAttribute('data-value');
                    console.log(`data-value changed to: ${newValue}`);
                    var element = $(mutation.target);
                    element.html(newValue.replace('px', '') + element.html().slice(2));
                    // You can perform any actions you want here when the attribute changes.
                }
            }
        });
        const observer5 = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-value') {
                    const newValue = mutation.target.getAttribute('data-value');
                    console.log(`data-value changed to: ${newValue}`);
                    var element = $(mutation.target);
                    console.log(element.html());
                    element.html(newValue.replace('px', '') + element.html().slice(2));
                    // You can perform any actions you want here when the attribute changes.
                }
            }
        });
        // Configure the observer to watch for attribute changes
        var viewbox = '<svg viewBox="0 0 18 18"><polygon class="ql-stroke" points="3 7 5 9 7 7 3 7"></polygon></svg>';
        const config = { attributes: true, attributeFilter: ['data-value'] };
        var html1 = $($('.ql-size > .ql-picker-label')[0]).html();
        var value1 = $($('.ql-size > .ql-picker-label')[0]).data('value').replace('px', '');
        $($('.ql-size > .ql-picker-label')[0]).html(value1 + '   ' + viewbox);

        var html2 = $($('.ql-size > .ql-picker-label')[1]).html();
        var value2 = $($('.ql-size > .ql-picker-label')[1]).data('value').replace('px', '');
        $($('.ql-size > .ql-picker-label')[1]).html(value2 + '   ' + viewbox);


        var html3 = $($('.ql-size > .ql-picker-label')[2]).html();
        var value3 = $($('.ql-size > .ql-picker-label')[2]).data('value').replace('px', '');
        $($('.ql-size > .ql-picker-label')[2]).html(value3 + '   ' + viewbox);


        var html4 = $($('.ql-size > .ql-picker-label')[3]).html();
        var value4 = $($('.ql-size > .ql-picker-label')[3]).data('value').replace('px', '');
        $($('.ql-size > .ql-picker-label')[3]).html(value4 + '   ' + viewbox);


        var html5 = $($('.ql-size > .ql-picker-label')[4]).html();
        var value5 = $($('.ql-size > .ql-picker-label')[4]).data('value').replace('px', '');
        $($('.ql-size > .ql-picker-label')[4]).html(value5 + '   ' + viewbox);

        // Start observing the target element
        observer.observe($('.ql-size > .ql-picker-label')[0], config);
        observer2.observe($('.ql-size > .ql-picker-label')[1], config);
        observer3.observe($('.ql-size > .ql-picker-label')[2], config);
        observer4.observe($('.ql-size > .ql-picker-label')[3], config);
        observer5.observe($('.ql-size > .ql-picker-label')[4], config);
    }) // end document ready
    function checkAndreturn(htmlElement) {
        //get current cursor position
        const sel = window.getSelection();
        const node = sel.focusNode;
        const offset = sel.focusOffset;
        const pos = getCursorPosition(htmlElement, node, offset, { pos: 0, done: false });
        if (offset === 0) pos.pos += 0.5;

        spellcheck(htmlElement);

        // restore the position
        sel.removeAllRanges();
        const range = setCursorPosition(htmlElement, document.createRange(), {
            pos: pos.pos,
            done: false,
        });
        range.collapse(true);
        sel.addRange(range);
    }
    // get the cursor position from .editor start
    function getCursorPosition(parent, node, offset, stat) {
        if (stat.done) return stat;

        let currentNode = null;
        if (parent.childNodes.length == 0) {
            stat.pos += parent.textContent.length;
        } else {
            for (let i = 0; i < parent.childNodes.length && !stat.done; i++) {
                currentNode = parent.childNodes[i];
                if (currentNode === node) {
                    stat.pos += offset;
                    stat.done = true;
                    return stat;
                } else getCursorPosition(currentNode, node, offset, stat);
            }
        }
        return stat;
    }

    //find the child node and relative position and set it on range
    function setCursorPosition(parent, range, stat) {
        if (stat.done) return range;

        if (parent.childNodes.length == 0) {
            if (parent.textContent.length >= stat.pos) {
                range.setStart(parent, stat.pos);
                stat.done = true;
            } else {
                stat.pos = stat.pos - parent.textContent.length;
            }
        } else {
            for (let i = 0; i < parent.childNodes.length && !stat.done; i++) {
                currentNode = parent.childNodes[i];
                setCursorPosition(currentNode, range, stat);
            }
        }
        return range;
    }

    function setCaretPosition(elemId, caretPos) {
        var elem = document.getElementById(elemId);

        if (elem != null) {
            if (elem.createTextRange) {
                var range = elem.createTextRange();
                range.move('character', caretPos);
                range.select();
            }
            else {
                if (elem.selectionStart) {
                    elem.focus();
                    elem.setSelectionRange(caretPos, caretPos);
                }
                else
                    elem.focus();
            }
        }
    }

    function removeDuplicates(arr) {
        return arr.filter((item,
            index) => arr.indexOf(item) === index);
    }

    var gg;
    function spellcheck(htmlElement) {

        const pattern = /\S+/g;
        gg = htmlElement;
        // gg = $(htmlElement).find(p);
        var p = $(htmlElement).find('p');

        removeDivsByClassName(htmlElement.parentElement.id);
        for (let idx = 0; idx < $(p).length; idx++) {
            if ($($(p)[idx]).find('img').length) {
                continue;
            }
            // let text = $(p)[idx].innerText.match(pattern);
            let text = $(p)[idx].innerText.split(/(?<=\s)/);
            var html = $(p)[idx].innerText;
            if (text == null) {
                break;
            }
            htmlArray = text.map(function (word) {
                word = trimSpecialCharacters(word).toLowerCase();
                var correct = typo.check(word) || ignoreTextLocal.includes(word);
                var className = correct ? 'border-bottom: 2px solid green;' : 'text-decoration-line: none;border-bottom: 2px solid red;';

                if (!correct) {
                    var positions = findAllExactTextPositionsOnScreen(word);
                    console.log(positions.length);
                    if (positions != null && positions.length > 0) {
                        positions.forEach((position, index) => {
                            createDivAtPositionWithSize(htmlElement.parentElement.id, word, true, position.x, position.y, position.width, position.height);
                        });
                    }
                }
                return `<u style="${className}">${word.trim()}</u>`;

            });
            //if ($(htmlElement).find('u').length == htmlArray.length) {
            //    console.log('=====');
            //}
            //    $($(p)[idx]).html(html + ' ');

            // html = "";
        }
    }

    function replaceNonFormattedText(input) {
        // Use regular expressions to match text within angle brackets and replace non-matching text
        const regex = /<[^>]+>.*?<\/[^>]+>|<([^>]+)>([^<]+)<\/\1>|([^<]+)/g;

        const replacedText = input.replace(regex, function (match, p1, p2, p3) {
            if (p1 && p2) {
                // Matched format <{TAGS}>ANYCHARACTER</TAGS>
                return match;
            } else if (p3) {
                // Non-matching text
                return `<u class="astext">${p3}</u>`;
            } else {
                return match;
            }
        });

        return replacedText;
    }


    function trimSpecialCharacters(inputString) {
        // Use the regular expression to replace the specified characters with an empty string
        var cleanedString = inputString.replace(/[. :;()[\]{}]+$/g, '');
        return cleanedString;
    }
    function findAllExactTextPositionsOnScreen(targetText) {
        let textNodes = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
        // Use the 'i' flag in the regular expression to make the search case-insensitive
        let regex = new RegExp('\\b' + targetText + '\\b', 'gi');
        let positions = [];

        while (textNodes.nextNode()) {
            const matches = [...textNodes.currentNode.textContent.matchAll(regex)];

            for (const match of matches) {
                const offset = match.index;
                const range = document.createRange();
                range.setStart(textNodes.currentNode, offset);
                range.setEnd(textNodes.currentNode, offset + targetText.length);
                const clientRects = range.getClientRects();

                if (clientRects.length > 0) {
                    positions.push({
                        x: clientRects[0].left + window.scrollX,
                        y: clientRects[0].top + window.scrollY,
                        offset: offset,
                        width: clientRects[0].width,
                        height: clientRects[0].height,
                    });
                }
            }
        }

        return positions;
    }



    function removeDivsByClassName(className) {
        console.log(className);
        var elements = document.getElementsByClassName(className);
        // Convert the HTMLCollection to an array (optional but helpful for looping)
        var elementsArray = Array.from(elements);

        console.log(elementsArray.length);
        for (var i = 0; i < elementsArray.length; i++) {

            var element = elementsArray[i];
            if ($(element).css('border-bottom').includes('none')) {
                continue;
            }
            element.parentNode.removeChild(element);
        }
    }
    function createDivAtPositionWithSize(parentId, word, mispelled, x, y, width, height) {
        const existingDiv = document.querySelector('.' + parentId + '[data-x="' + x + '"][data-y="' + y + '"]');

        if (existingDiv) {
            // Div with the same position already exists, do not create a new one.
            return;
        }
        // Create a new div element
        var div = document.createElement('div');

        // Set the position and size of the div using CSS
        div.style.position = 'absolute';
        div.style.left = x + 'px';
        div.style.top = y + 'px';
        div.style.width = width + 'px';
        div.style.height = height + 'px';
        div.className = parentId;
        // Add content or styles to the div as needed
        div.style.zIndex = '-100000000';
        div.style.backgroundColor = 'rgba(255, 255, 0, 0.5);';
        div.style.display = 'block';
        div.style.borderBottom = mispelled == true ? '2px solid red' : '2px solid green';
        div.dataset.text = word;
        // Append the div to the document's body
        // Set data attributes to store the position
        div.dataset.x = x;
        div.dataset.y = y;

        document.body.appendChild(div);
    }

    function getSelectedText() {
        var text = '';
        if (window.getSelection) {
            text = window.getSelection().toString();
        } else if (document.selection && document.selection.type != 'Control') {
            text = document.selection.createRange().text;
        }
        return text;
    }

    function ignoreText(event) {
        let targetElement = event.data.targetElement;
        console.log(targetElement);
        $(targetElement).css('border-bottom', 'none');
        $('.ql-contextmenu').hide();
    }
    function addToDictionary(event) {
        let targetElement = event.data.targetElement;
        ignoreTextLocal.push($(targetElement).data('text'));

        localStorage.setItem('ignoreTextLocal', JSON.stringify(ignoreTextLocal));
        $('.ql-contextmenu').hide();
        checkAndreturn($('#editor > .ql-editor')[0]);
        checkAndreturn($('#editor2 > .ql-editor')[0]);
        checkAndreturn($('#editor3 > .ql-editor')[0]);
        checkAndreturn($('#editor4 > .ql-editor')[0]);
        checkAndreturn($('#editor5 > .ql-editor')[0]);
    }

    function deleteImage(event) {
        let targetElement = event.data.targetElement;
        $(targetElement).remove();
        $('.ql-contextmenu').hide();
    }

    function convertImgStringToDivString(imgString) {
        // Create a temporary div element to parse the imgString
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = imgString;

        // Create a div element with the class "thumbnail"
        var divElement = document.createElement('div');
        divElement.className = 'thumbnail';

        // Find the img element within the parsed HTML
        var imgElement = tempDiv.querySelector('img');
        if (imgElement) {
            // Create the anchor tag with the class "imagelink" and "internalimage"
            var imgLink = document.createElement('a');
            imgLink.className = 'imagelink';
            imgLink.href = imgElement.src;
            imgLink.target = '_blank';
            imgLink.rel = 'noopener';
            imgLink.className += " open-image";
            // Clone the img element and add the "async" attribute
            var clonedImg = imgElement.cloneNode(true);
            clonedImg.setAttribute('decoding', 'async');
            clonedImg.className += " open-image";
            // Create the "internalimage" anchor tag
            var internalLink = document.createElement('a');
            internalLink.className = 'internalimage';
            internalLink.href = imgElement.src;
            internalLink.target = '_blank';
            internalLink.rel = 'noopener';
            internalLink.textContent = 'Click For Full Size';
            internalLink.className += " open-image";
            // Append elements to the divElement
            imgLink.appendChild(clonedImg);
            divElement.appendChild(imgLink);
            divElement.appendChild(document.createElement('br'));
            divElement.appendChild(document.createElement('br'));
            divElement.appendChild(internalLink);
            divElement.appendChild(document.createElement('p'));
        }

        // Convert the modified div to an HTML string
        var divString = divElement.outerHTML;

        return divString;
    }

    function extractImgStringsFromHtml(htmlString) {
        var imgStrings = [];

        // Create a temporary div element to parse the HTML string
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlString;

        // Find all img elements within the parsed HTML
        var imgElements = tempDiv.querySelectorAll('img');

        imgElements.forEach(function (imgElement) {
            // Convert each img element to a string and add it to the imgStrings array
            imgStrings.push(imgElement.outerHTML);
        });

        return imgStrings;
    }

    function extractAndConvertImgsToDivs(htmlString) {
        // Step 1: Extract all img tag strings
        var imgTagRegex = /<img[^>]+>/g;
        var imgTags = htmlString.match(imgTagRegex);

        if (!imgTags) {
            return htmlString; // No img tags found, return the original HTML
        }

        // Step 2: Convert each img tag string to the desired div string
        var divStrings = imgTags.map(function (imgTag) {
            return convertImgStringToDivString(imgTag);
        });

        // Step 3: Replace original img tag strings with the new div strings
        for (var i = 0; i < imgTags.length; i++) {
            htmlString = htmlString.replace(imgTags[i], divStrings[i]);
        }

        return htmlString;
    }

</script>
