<!-- Include stylesheet -->
<html>
<head>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<style type="text/css">


    .ql-snow {
        .ql-picker

    {
        &.ql-size

    {
        .ql-picker-label, .ql-picker-item

    {
        &::before

    {
        content: attr(data-value) !important;
    }

    }
    }
    }
    }

   /* .ql-formats {
        display: block !important;
    }*/

   /* .ql-toolbar {
        box-shadow: inset -1px -1px 100px 100px white;
    }*/

    .ql-container {
        height:200px;
    }

    .ql-editor {
        font-family: Arial !important;
    }

    p:empty:not(:focus)::before {
        content: attr(data-placeholder);
    }

    /*.ql-toolbar button {
        width: 150px !important;
        text-align:left!important;
    }*/

    img {
        height:70%!important;
    }

    .ql-contextmenu-btn {
        background-color: white;
        z-index: 10000;
        width: 150px;
        text-align:left;
        float:none;
        display:block;
        border:none;
    }

    .section-header{
        margin-top:30px;
    }
</style>
<!-- Create the editor container -->

</head>

<body>
    <h1 style="text-align:center">KBI Generator</h1>
<p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Version</strong></p>
<div id="editor"></div>

<p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Date</strong></p>
<div id="editor2"></div>
<p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Summary</strong></p>
<div id="editor3"></div>
<p class="section-header" contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Technical Background</strong></p>
<div id="editor4"></div>
<p class="section-header"  contenteditable='false'><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Resolution</strong></p>
<div id="editor5"></div>

<div id="ql-contextmenu" class="ql-contextmenu">
    <button id="insertImage" onclick="insertImage()">Insert Image here.</button>
    <button style="display:block">Show Mockup</button>
    <button style="display:block">Generate KBI</button>
</div>
</body>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<!-- Include the Quill library -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<!-- Initialize Quill editor -->
<script>
    //var Size = Quill.import('attributors/style/size');
    //Size.whitelist = ['10px', '12px', '14px', '16px'];
    //Quill.register(Size, true);
    var Size = Quill.import('attributors/style/size');
    Size.whitelist = [
        "10px",
        "12px",
        "14px",
        "16px"
    ];
    Quill.register(Size, true);
    var toolbarOptions = [
        ['image'],
       // ['preview'],
      //  ['generate'],
        ['bold'],        // toggled buttons
        [{
            'size': ["10px",
                "12px",
                "14px",
                "16px"]
        }],  // custom dropdown
        [{ 'color': [] }],
        
    ];

    var quill = new Quill('#editor', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your text here...',
        theme: 'snow'
    });
      var quill2 = new Quill('#editor2', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your text here...',
        theme: 'snow'
      });
      var quill3 = new Quill('#editor3', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your text here...',
        theme: 'snow'
      });
      var quill4 = new Quill('#editor4', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your text here...',
        theme: 'snow'
      });
      var quill5 = new Quill('#editor5', {
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'Your text here...',
        theme: 'snow'
    });

    var toolbar = quill.getModule('toolbar');
    toolbar.addHandler('preview', function () {
        console.log('preview')
    });
    for(item of document.getElementsByClassName('ql-image'))
    {
        $(item).hide()
    }
    //var previewBtn = document.querySelector('.ql-image');
    //previewBtn.innerHTML = "Insert Image Here.";
    //var previewBtn = document.querySelector('.ql-preview');
    //previewBtn.innerHTML = "Show Mockup";
    //previewBtn.addEventListener('click', function () {
    //    var x = "height=800px,width=800px;toolbar=0,location=50,menubar=0";
    //    console.log(x);
    //    var w = window.open('', '_blank', x);
    //    //var w = window.open('new.html','_blank');
    //    w.document.writeln(quill.container.firstChild.innerHTML);

    //});

    //var generateBtn = document.querySelector('.ql-generate');
    //generateBtn.innerHTML = "Generate KBI";
    //generateBtn.addEventListener('click', function () {
    //    var images = img_find();
    //    var html = quill.container.firstChild.innerHTML;
    //    const fd = new FormData();
    //    fd.append('Html', html);
    //    fd.append('Images', images);

    //    const xhr = new XMLHttpRequest();
    //    xhr.open('POST', 'https://c569-184-22-219-255.ngrok-free.app/api/kbi/upload/', true);
    //    xhr.onload = () => {
    //        if (xhr.status === 200) {
    //            var x = JSON.parse(xhr.response);
    //            window.open(x.file.url);
    //             location.reload();
    //        }
    //    };
    //    xhr.send(fd);

    //});

    function selectLocalImage() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.click();

        // Listen upload local image and save to server
        input.onchange = () => {
            const file = input.files[0];

            // file type is only image.
            if (/^image\//.test(file.type)) {
                saveToServer(file);
            } else {
                console.warn('You could only upload images.');
            }
        };
    }


    /**
     * Step2. save to server
     *
     */
    function saveToServer(file) {
        const fd = new FormData();
        fd.append('image', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://c569-184-22-219-255.ngrok-free.app/api/images/upload', true);
        xhr.onload = () => {
            if (xhr.status === 200) {
                // this is callback data: url
                var x = JSON.parse(xhr.response);
                console.log(x); console.log(x.file);
                insertToEditor(x.file.url);
            }
        };
        xhr.send(fd);
    }

    function img_find() {
        return Array.from(document.getElementsByTagName("img")).map(i => i.src);
    }

    /**
     * Step3. insert image url to rich editor.
     *
     */
    function insertToEditor(url) {
        // push image url to rich editor.
        const range = quill.getSelection();
        console.log(url);
        quill.insertEmbed(range.index, 'image', url);
    }

    // quill editor add image handler
    //quill.getModule('toolbar').addHandler('image', (x) => {
     //   console.log(x);
   //     selectLocalImageAsData();
        //selectLocalImage();
   // });

    //quill.pasteHTML(
    //    "<p style='left:50px;'>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Date</strong></p>" +
    //    "<p>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Summary</strong></p>" +
    //    "<p>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Technical Background</strong></p>" +
    //    "<p>Your text here<br><br><br><br></p>" +
    //    "<p><strong style='color: rgb(178, 107, 0); font-size: 16px;'>Resolution</strong></p>" +
    //    "<p class='x'>Your text here<br><br><br><br></p>"
    //);
    var tempState = '';

    function insertImage() {
        if (tempState == 'editor') {
            $(quill.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor2') {
            $(quill2.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor3') {
            $(quill3.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor4') {
            $(quill4.getModule('toolbar').controls[0][1]).click()
        }
        if (tempState == 'editor5') {
            $(quill5.getModule('toolbar').controls[0][1]).click()
        }
    }
    $(document).ready(function () {
        $('.ql-contextmenu').hide();

        document.addEventListener('contextmenu', function (event) {
            event.preventDefault();
            
                $('#insertImage').show();
            if (document.getElementById('editor').contains(event.target)) {
                tempState = 'editor';
            }
            else if (document.getElementById('editor2').contains(event.target)) {
                tempState = 'editor2';
            }
            else if (document.getElementById('editor3').contains(event.target)) {
                tempState = 'editor3';
            }
            else if (document.getElementById('editor4').contains(event.target)) {
                tempState = 'editor4';
            }
            else if (document.getElementById('editor5').contains(event.target)) {
                tempState = 'editor5';
            }
            else {
                tempState = '';
                $('#insertImage').hide();
            }
            $('.ql-contextmenu').css('left', event.clientX);
            $('.ql-contextmenu').css('top', event.clientY);
            $('.ql-contextmenu').css('position', 'fixed');
            $('.ql-contextmenu').css('z-index', 10000);
            $('.ql-contextmenu').show();
        });

        $(document).click(function () {
            //$('div.ql-toolbar').hide();
        });

        window.addEventListener('click', function (e) {
            if (document.getElementById('ql-contextmenu').contains(e.target)) {
            } else {
                $('div.ql-contextmenu').hide();
            }
        });
    })
</script>
